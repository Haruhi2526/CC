# ãƒ©ãƒ³ã‚­ãƒ³ã‚°å‹é”è¿½åŠ æ©Ÿèƒ½å®Ÿè£…

**ä½œæˆæ—¥**: 2025å¹´1æœˆ  
**å¯¾è±¡æ©Ÿèƒ½**: ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«LINEå‹é”ã‚’è¿½åŠ ã™ã‚‹æ©Ÿèƒ½  
**å®Ÿè£…çŠ¶æ³**: âœ… å®Œäº†

---

## ğŸ“‹ å®Ÿè£…å®Œäº†é …ç›®

### âœ… ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…

1. **ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”»é¢ã®æ›´æ–°**
   - ã€Œå‹é”ã‚’æ‹›å¾…ã€ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
   - ã€Œå‹é”ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã€ã‚¿ãƒ–ã‚’è¿½åŠ 
   - æ‹›å¾…ãƒªãƒ³ã‚¯ç”Ÿæˆæ©Ÿèƒ½ã‚’å®Ÿè£…

2. **æ‹›å¾…ãƒªãƒ³ã‚¯ã®å‡¦ç†**
   - `index.html`ã§æ‹›å¾…ãƒªãƒ³ã‚¯ã®å‡¦ç†ã‚’å®Ÿè£…
   - èªè¨¼å¾Œã«è‡ªå‹•çš„ã«å‹é”é–¢ä¿‚ã‚’è¿½åŠ 

3. **APIé–¢æ•°ã®è¿½åŠ **
   - `api.addFriend()` - å‹é”é–¢ä¿‚ã‚’è¿½åŠ 
   - `api.getFriends()` - å‹é”ãƒªã‚¹ãƒˆã‚’å–å¾—

### âœ… ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å®Ÿè£…

1. **friends Lambdaé–¢æ•°**
   - `/friends/add` (POST) - å‹é”é–¢ä¿‚ã‚’è¿½åŠ 
   - `/friends/list` (GET) - å‹é”ãƒªã‚¹ãƒˆã‚’å–å¾—

2. **ranking Lambdaé–¢æ•°ã®æ‹¡å¼µ**
   - `/ranking/friends/weekly` (GET) - å‹é”é€±é–“ãƒ©ãƒ³ã‚­ãƒ³ã‚°å–å¾—
   - `/ranking/friends/monthly` (GET) - å‹é”æœˆé–“ãƒ©ãƒ³ã‚­ãƒ³ã‚°å–å¾—

---

## ğŸ¯ å®Ÿè£…æ–¹æ³•: ã‚·ã‚§ã‚¢æ©Ÿèƒ½ã§å‹é”ã‚’æ‹›å¾…

### å®Ÿè£…å†…å®¹

1. **ã‚·ã‚§ã‚¢æ©Ÿèƒ½ã®æ‹¡å¼µ**
   - ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”»é¢ã®ã€Œå‹é”ã‚’æ‹›å¾…ã€ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
   - æ‹›å¾…URLã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã™ã‚‹æ©Ÿèƒ½ã‚’å®Ÿè£…
   - æ‹›å¾…ãƒªãƒ³ã‚¯ã«æ‹›å¾…å…ƒã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å«ã‚ã‚‹

2. **æ‹›å¾…ãƒªãƒ³ã‚¯ã®å‡¦ç†**
   - ã‚¢ãƒ—ãƒªã‚’é–‹ã„ãŸã¨ãã«ã€URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰æ‹›å¾…å…ƒã‚’å–å¾—
   - æ‹›å¾…å…ƒã¨å‹é”é–¢ä¿‚ã‚’DynamoDBã«ä¿å­˜

3. **å‹é”ãƒªã‚¹ãƒˆã®è¡¨ç¤º**
   - ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”»é¢ã§å‹é”ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’è¡¨ç¤ºï¼ˆé€±é–“/æœˆé–“ã‚¿ãƒ–ã§åˆ‡ã‚Šæ›¿ãˆï¼‰
   - å‹é”ã¨è‡ªåˆ†è‡ªèº«ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’è¡¨ç¤º
   - è‡ªåˆ†è‡ªèº«ã®é …ç›®ã¯ã€Œ(ã‚ãªãŸ)ã€ã¨è¡¨ç¤ºã•ã‚Œã€å¼·èª¿è¡¨ç¤ºã•ã‚Œã‚‹

### å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«

#### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰: `frontend/liff-app/js/ranking.js`

```javascript
// å‹é”ã‚’æ‹›å¾…ã™ã‚‹æ©Ÿèƒ½
async function inviteFriend() {
    try {
        if (typeof liff === 'undefined' || !liff.isInClient()) {
            alert('å‹é”ã‚’æ‹›å¾…ã™ã‚‹ã«ã¯LINEã‚¢ãƒ—ãƒªå†…ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ã€‚');
            return;
        }

        const userId = sessionStorage.getItem(CONFIG.STORAGE_KEYS.USER_ID);
        if (!userId) {
            alert('ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚');
            return;
        }

        // æ‹›å¾…ãƒªãƒ³ã‚¯ã‚’ç”Ÿæˆ
        const inviteUrl = `${window.location.origin}/index.html?invite=${userId}`;
        const inviteText = `ğŸ† ã‚¹ã‚¿ãƒ³ãƒ—ãƒ©ãƒªãƒ¼ã«å‚åŠ ã—ã‚ˆã†ï¼\n\n` +
                          `ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã§ç«¶ã„åˆãŠã†ï¼\n\n` +
                          `${inviteUrl}`;

        // shareTargetPickerã§å‹é”ã«ã‚·ã‚§ã‚¢
        await liff.shareTargetPicker([
            {
                type: 'text',
                text: inviteText
            }
        ]);

        console.log('å‹é”æ‹›å¾…ã‚’é€ä¿¡ã—ã¾ã—ãŸ');
    } catch (error) {
        console.error('å‹é”æ‹›å¾…ã‚¨ãƒ©ãƒ¼:', error);
        if (error.code !== 'CANCEL') {
            alert('å‹é”æ‹›å¾…ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
        }
    }
}

// æ‹›å¾…ãƒªãƒ³ã‚¯ã‹ã‚‰é–‹ã„ãŸå ´åˆã®å‡¦ç†
function handleInviteLink() {
    const urlParams = new URLSearchParams(window.location.search);
    const inviteUserId = urlParams.get('invite');
    
    if (inviteUserId) {
        // æ‹›å¾…å…ƒã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’ä¿å­˜
        sessionStorage.setItem('invite_user_id', inviteUserId);
        
        // å‹é”é–¢ä¿‚ã‚’ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡
        addFriendRelationship(inviteUserId);
    }
}

// å‹é”é–¢ä¿‚ã‚’è¿½åŠ 
async function addFriendRelationship(friendUserId) {
    try {
        const userId = sessionStorage.getItem(CONFIG.STORAGE_KEYS.USER_ID);
        if (!userId || !friendUserId) {
            return;
        }

        // è‡ªåˆ†è‡ªèº«ã‚’è¿½åŠ ã—ãªã„
        if (userId === friendUserId) {
            return;
        }

        await api.addFriend(userId, friendUserId);
        console.log('å‹é”é–¢ä¿‚ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
    } catch (error) {
        console.error('å‹é”é–¢ä¿‚è¿½åŠ ã‚¨ãƒ©ãƒ¼:', error);
    }
}
```

#### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰: `frontend/liff-app/js/api.js`

```javascript
// apiã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«è¿½åŠ 
async addFriend(userId, friendUserId) {
    return await apiCall('/friends/add', {
        method: 'POST',
        body: JSON.stringify({
            user_id: userId,
            friend_id: friendUserId
        })
    });
},

async getFriends(userId) {
    const endpoint = `/friends/list?user_id=${encodeURIComponent(userId)}`;
    return await apiCall(endpoint, {
        method: 'GET'
    });
}
```

#### ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰: `backend/lambda/friends/lambda_function.py`

```python
import json
import boto3
from datetime import datetime
from response_utils import create_response, create_error_response

dynamodb = boto3.resource('dynamodb')
friends_table = dynamodb.Table(os.environ.get('TABLE_FRIENDS', 'Friends'))

def lambda_handler(event, context):
    try:
        if event.get('httpMethod') == 'OPTIONS':
            return create_response(200, {})
        
        method = event.get('httpMethod')
        path = event.get('path', '')
        
        if method == 'POST' and '/friends/add' in path:
            body = json.loads(event.get('body', '{}'))
            user_id = body.get('user_id')
            friend_id = body.get('friend_id')
            return add_friend(user_id, friend_id)
        elif method == 'GET' and '/friends/list' in path:
            query_params = event.get('queryStringParameters') or {}
            user_id = query_params.get('user_id')
            return get_friends(user_id)
        else:
            return create_error_response(404, 'Not Found')
    except Exception as e:
        return create_error_response(500, f'Internal Server Error: {str(e)}')

def add_friend(user_id, friend_id):
    """å‹é”é–¢ä¿‚ã‚’è¿½åŠ ï¼ˆåŒæ–¹å‘ï¼‰"""
    if not user_id or not friend_id:
        return create_error_response(400, 'user_id and friend_id are required')
    
    if user_id == friend_id:
        return create_error_response(400, 'Cannot add yourself as a friend')
    
    try:
        # åŒæ–¹å‘ã®å‹é”é–¢ä¿‚ã‚’è¿½åŠ 
        timestamp = int(datetime.now().timestamp())
        
        # user_id -> friend_id
        friends_table.put_item(
            Item={
                'UserId': user_id,
                'FriendId': friend_id,
                'CreatedAt': timestamp,
                'Status': 'active'
            }
        )
        
        # friend_id -> user_idï¼ˆåŒæ–¹å‘ï¼‰
        friends_table.put_item(
            Item={
                'UserId': friend_id,
                'FriendId': user_id,
                'CreatedAt': timestamp,
                'Status': 'active'
            }
        )
        
        return create_response(200, {
            'ok': True,
            'message': 'Friend relationship added successfully'
        })
    except Exception as e:
        return create_error_response(500, f'Failed to add friend: {str(e)}')

def get_friends(user_id):
    """å‹é”ãƒªã‚¹ãƒˆã‚’å–å¾—"""
    if not user_id:
        return create_error_response(400, 'user_id is required')
    
    try:
        response = friends_table.query(
            KeyConditionExpression='UserId = :user_id',
            ExpressionAttributeValues={
                ':user_id': user_id
            },
            FilterExpression='#status = :status',
            ExpressionAttributeNames={
                '#status': 'Status'
            },
            ExpressionAttributeValues={
                ':user_id': user_id,
                ':status': 'active'
            }
        )
        
        friends = [item['FriendId'] for item in response.get('Items', [])]
        
        return create_response(200, {
            'ok': True,
            'friends': friends
        })
    except Exception as e:
        return create_error_response(500, f'Failed to get friends: {str(e)}')
```

---

## ğŸ¯ å®Ÿè£…æ–¹æ³•2: ã‚°ãƒ«ãƒ¼ãƒ—æ©Ÿèƒ½ã‚’ä½¿ã†

### å®Ÿè£…å†…å®¹

1. **ã‚°ãƒ«ãƒ¼ãƒ—æƒ…å ±ã®å–å¾—**
   - `liff.getContext()`ã§ã‚°ãƒ«ãƒ¼ãƒ—æƒ…å ±ã‚’å–å¾—
   - ã‚°ãƒ«ãƒ¼ãƒ—å†…ã®ãƒ¡ãƒ³ãƒãƒ¼ã‚’å–å¾—

2. **ã‚°ãƒ«ãƒ¼ãƒ—ãƒ¡ãƒ³ãƒãƒ¼ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤º**
   - ã‚°ãƒ«ãƒ¼ãƒ—å†…ã®ãƒ¡ãƒ³ãƒãƒ¼ã®ã¿ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’è¡¨ç¤º

### å®Ÿè£…ä¾‹

```javascript
// ã‚°ãƒ«ãƒ¼ãƒ—æƒ…å ±ã‚’å–å¾—
async function getGroupMembers() {
    try {
        const context = liff.getContext();
        if (context && context.type === 'group') {
            const groupId = context.groupId;
            // ã‚°ãƒ«ãƒ¼ãƒ—ãƒ¡ãƒ³ãƒãƒ¼ã‚’å–å¾—ï¼ˆã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§å®Ÿè£…ãŒå¿…è¦ï¼‰
            const members = await api.getGroupMembers(groupId);
            return members;
        }
        return [];
    } catch (error) {
        console.error('ã‚°ãƒ«ãƒ¼ãƒ—ãƒ¡ãƒ³ãƒãƒ¼å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        return [];
    }
}
```

---

## ğŸ“Š DynamoDBãƒ†ãƒ¼ãƒ–ãƒ«è¨­è¨ˆ

### Friendsãƒ†ãƒ¼ãƒ–ãƒ«

```
ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ã‚­ãƒ¼: UserId (String)
ã‚½ãƒ¼ãƒˆã‚­ãƒ¼: FriendId (String)
å±æ€§:
  - CreatedAt: Number (ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—)
  - Status: String ('active', 'blocked')
```

---

## ğŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †

### Step 1: DynamoDBãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ

1. AWS DynamoDBã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§`Friends`ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆ
2. ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ã‚­ãƒ¼: `UserId` (String)
3. ã‚½ãƒ¼ãƒˆã‚­ãƒ¼: `FriendId` (String)
4. ãƒ†ãƒ¼ãƒ–ãƒ«å: `Friends`

#### ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ 
```
UserId (PK): "U1234567890..."
FriendId (SK): "U0987654321..."
CreatedAt: 1234567890
Status: "active"
```

### Step 2: friends Lambdaé–¢æ•°ã®ãƒ‡ãƒ—ãƒ­ã‚¤

1. **ZIPãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ**
   ```bash
   cd backend/lambda/friends
   ./build.sh
   ```

2. **AWS Lambdaé–¢æ•°ã®ä½œæˆ**
   - é–¢æ•°å: `friends`
   - ãƒ©ãƒ³ã‚¿ã‚¤ãƒ : Python 3.11
   - ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰

3. **ç’°å¢ƒå¤‰æ•°ã®è¨­å®š**
   - `TABLE_FRIENDS`: `Friends`ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼‰

4. **IAMãƒ­ãƒ¼ãƒ«ã®è¨­å®š**
   - DynamoDBèª­ã¿æ›¸ãæ¨©é™ã‚’è¿½åŠ 

5. **API Gatewayçµ±åˆ**
   - `POST /friends/add` - å‹é”é–¢ä¿‚ã‚’è¿½åŠ 
   - `GET /friends/list` - å‹é”ãƒªã‚¹ãƒˆã‚’å–å¾—

### Step 3: ranking Lambdaé–¢æ•°ã®æ›´æ–°

1. **ZIPãƒ•ã‚¡ã‚¤ãƒ«ã®å†ä½œæˆ**
   ```bash
   cd backend/lambda/ranking
   ./build.sh
   ```

2. **Lambdaé–¢æ•°ã‚’æ›´æ–°**
   - æ–°ã—ã„ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰

3. **API Gatewayçµ±åˆ**
   - `GET /ranking/friends/weekly` - å‹é”é€±é–“ãƒ©ãƒ³ã‚­ãƒ³ã‚°å–å¾—
   - `GET /ranking/friends/monthly` - å‹é”æœˆé–“ãƒ©ãƒ³ã‚­ãƒ³ã‚°å–å¾—

### Step 4: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ãƒ‡ãƒ—ãƒ­ã‚¤

å®Ÿè£…æ¸ˆã¿ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤:
- `frontend/liff-app/ranking.html`
- `frontend/liff-app/js/ranking.js`
- `frontend/liff-app/js/api.js`
- `frontend/liff-app/js/app.js`

---

## ğŸ“ ä½¿ç”¨æ–¹æ³•

### å‹é”ã‚’æ‹›å¾…ã™ã‚‹

1. ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”»é¢ã§ã€Œå‹é”ã‚’æ‹›å¾…ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
2. å‹é”é¸æŠç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã‚‹
3. æ‹›å¾…ã—ãŸã„å‹é”ã‚’é¸æŠ
4. å‹é”ãŒæ‹›å¾…ãƒªãƒ³ã‚¯ã‹ã‚‰ã‚¢ãƒ—ãƒªã‚’é–‹ãã¨ã€è‡ªå‹•çš„ã«å‹é”é–¢ä¿‚ãŒè¿½åŠ ã•ã‚Œã‚‹

### å‹é”ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’è¡¨ç¤ºã™ã‚‹

1. ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”»é¢ã§ã€Œå‹é”ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã€ã‚¿ãƒ–ã‚’é¸æŠ
2. å‹é”ã®ã¿ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãŒè¡¨ç¤ºã•ã‚Œã‚‹

---

## âš ï¸ æ³¨æ„äº‹é …

1. **ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼**
   - å‹é”é–¢ä¿‚ã¯åŒæ–¹å‘ã§ä¿å­˜ã•ã‚Œã‚‹
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå‹é”é–¢ä¿‚ã‚’å‰Šé™¤ã§ãã‚‹æ©Ÿèƒ½ã‚’å®Ÿè£…ã™ã‚‹ã“ã¨ã‚’æ¨å¥¨

2. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**
   - å‹é”æ•°ãŒå¤šã„å ´åˆã€ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¨ˆç®—ã«æ™‚é–“ãŒã‹ã‹ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹
   - ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè£…ã™ã‚‹ã“ã¨ã‚’æ¨å¥¨

3. **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã®æ¤œè¨¼ã‚’å¿…ãšè¡Œã†
   - ä¸æ­£ãªå‹é”é–¢ä¿‚ã®è¿½åŠ ã‚’é˜²ã

---

**æœ€çµ‚æ›´æ–°**: 2025å¹´1æœˆ

