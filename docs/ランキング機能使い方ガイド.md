# ランキング機能使い方ガイド

**作成日**: 2025年1月

---

## 📱 ユーザー向け使い方

### ランキング画面の表示

1. **LIFFアプリを開く**
   - LINEアプリからスタンプラリーアプリを開く
   - または、ブラウザで `ranking.html` にアクセス

2. **ランキング画面にアクセス**
   - ホーム画面から「ランキング」ボタンをクリック
   - または、直接 `ranking.html` のURLにアクセス

3. **週間/月間の切り替え**
   - 画面上部の「週間」「月間」タブをタップ
   - タブを切り替えると、該当期間のランキングが表示されます

### ランキングの見方

- **順位**: 1位、2位、3位...と表示されます
- **メダル表示**: トップ3にはメダルアイコンが表示されます
  - 🥇 1位
  - 🥈 2位
  - 🥉 3位
- **ユーザー名**: 各ユーザーの表示名
- **スタンプ数**: その期間に獲得したスタンプの数

### シェア機能

1. **「結果をシェア」ボタンをクリック**
   - ランキング画面下部のボタンをタップ

2. **シェア方法**
   - **LINEシェア（shareTargetPicker）**: LINEアプリ内で開いている場合、友達選択画面が表示されます
   - **URLコピー**: LINEシェアが使えない場合、URLがクリップボードにコピーされます

3. **シェア内容**
   - 現在表示中のランキング（週間/月間）の1位情報
   - ランキングページへのリンク

4. **シェア機能が動作しない場合**
   - LINE Developers Consoleで「Share Target Picker」の設定を有効にする必要があります（下記参照）

---

## ⚙️ shareTargetPickerの設定（重要）

`shareTargetPicker`機能を使用するには、LINE Developers Consoleで設定が必要です。

### 設定手順

1. **LINE Developers Consoleにアクセス**
   - [LINE Developers Console](https://developers.line.biz/console/)にログイン

2. **チャネルを選択**
   - スタンプラリーアプリのチャネルを選択

3. **LIFFアプリの設定を開く**
   - 「LIFF」タブをクリック
   - 該当するLIFFアプリを選択（または新規作成）

4. **Share Target Pickerを有効化**
   - LIFFアプリの設定画面で「Share Target Picker」の設定を探す
   - 「有効にする」または「Enable」を選択
   - 利用規約に同意する

5. **保存**
   - 設定を保存

### 注意事項

- `shareTargetPicker`はLINEアプリ内でのみ動作します
- ブラウザで直接開いた場合は、URLコピー機能（フォールバック）が使用されます
- 設定を有効化しないと、`shareTargetPicker`が使用できません

---

## 🔧 管理者・開発者向け使い方

### ランキング計算の実行

ランキングを表示する前に、ランキングデータを計算する必要があります。

#### 方法1: API経由で手動実行

```bash
# 週間ランキングを計算
curl -X POST "https://2bm71jvfs6.execute-api.us-east-1.amazonaws.com/dev/ranking/calculate?type=weekly"

# 月間ランキングを計算
curl -X POST "https://2bm71jvfs6.execute-api.us-east-1.amazonaws.com/dev/ranking/calculate?type=monthly"
```

#### 方法2: EventBridgeで自動実行（推奨）

1. **EventBridgeルールの作成**
   - Amazon EventBridgeコンソールにアクセス
   - 「ルール」→「ルールの作成」
   - スケジュール: 毎日午前1時（UTC）
   - ターゲット: Lambda関数 `ranking`

2. **自動実行の設定**
   - 週間ランキング: 毎週月曜日の午前1時
   - 月間ランキング: 毎月1日の午前1時

### ランキングデータの取得

#### 週間ランキング

```bash
# 現在の週のランキングを取得
curl -X GET "https://2bm71jvfs6.execute-api.us-east-1.amazonaws.com/dev/ranking/weekly"

# 特定の週のランキングを取得
curl -X GET "https://2bm71jvfs6.execute-api.us-east-1.amazonaws.com/dev/ranking/weekly?period=2025-W45"
```

#### 月間ランキング

```bash
# 現在の月のランキングを取得
curl -X GET "https://2bm71jvfs6.execute-api.us-east-1.amazonaws.com/dev/ranking/monthly"

# 特定の月のランキングを取得
curl -X GET "https://2bm71jvfs6.execute-api.us-east-1.amazonaws.com/dev/ranking/monthly?period=2025-11"
```

#### 友達比較

```bash
curl -X GET "https://2bm71jvfs6.execute-api.us-east-1.amazonaws.com/dev/ranking/compare?user_id=USER_ID&friend_id=FRIEND_ID"
```

---

## 📊 ランキングの仕組み

### ランキング計算のルール

1. **期間の定義**
   - **週間ランキング**: 現在の週の月曜日0時から日曜日23時59分まで
   - **月間ランキング**: 現在の月の1日0時から月末23時59分まで

2. **スタンプ数のカウント**
   - 期間内に獲得したスタンプのみをカウント
   - `UserStamps`テーブルの`CollectedAt`（獲得日時）で判定

3. **順位の決定**
   - スタンプ数の多い順にランク付け
   - 同数の場合は、先にスタンプを獲得した順

### データの保存先

- **テーブル**: `Rankings`
- **キー構造**:
  - パーティションキー: `Period` (例: "weekly-2025-W45")
  - ソートキー: `Rank` (1, 2, 3, ...)

---

## 🎯 使用例

### 例1: 週間ランキングの確認

1. ユーザーがランキング画面を開く
2. 「週間」タブを選択
3. 現在の週のランキングが表示される
4. 自分の順位とスタンプ数を確認

### 例2: ランキングのシェア

1. ランキング画面で「結果をシェア」をタップ
2. LINEの友達選択画面が表示される
3. シェアしたい友達を選択
4. ランキング情報が送信される

### 例3: 管理者がランキングを更新

1. 毎日午前1時にEventBridgeが自動実行
2. `ranking` Lambda関数が呼び出される
3. 週間/月間ランキングが再計算される
4. DynamoDBの`Rankings`テーブルに保存される

---

## ⚠️ 注意事項

### ユーザー向け

- ランキングは定期的に更新されます（通常は1日1回）
- スタンプを獲得しても、ランキングに反映されるまで時間がかかる場合があります
- 週間ランキングは毎週月曜日にリセットされます
- 月間ランキングは毎月1日にリセットされます

### 管理者向け

- ランキング計算は`UserStamps`テーブルをスキャンするため、ユーザー数が多い場合は時間がかかります
- ランキング計算は定期的に実行することを推奨します（日次など）
- DynamoDBの読み取り容量ユニットを消費するため、コストに注意してください

---

## 🔗 関連ドキュメント

- [ランキング機能実装手順](./ランキング機能実装手順.md)
- [API仕様書](./API仕様書.md)

---

**最終更新**: 2025年1月

