# CORSã‚¨ãƒ©ãƒ¼è¨ºæ–­ã¨è§£æ±ºãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

## ğŸ”´ ç¾åœ¨ã®ã‚¨ãƒ©ãƒ¼

```
Access to fetch at 'https://c5nmu4q3di.execute-api.us-east-1.amazonaws.com/dev/auth/verify' 
from origin 'https://semiemotionally-nonanarchistic-beverley.ngrok-free.dev' 
has been blocked by CORS policy: 
Response to preflight request doesn't pass access control check: 
No 'Access-Control-Allow-Origin' header is present on the requested resource.
```

---

## ğŸ” è¨ºæ–­æ‰‹é †

### ã‚¹ãƒ†ãƒƒãƒ—1: OPTIONSãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãƒ†ã‚¹ãƒˆ

ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã€OPTIONSãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒæ­£ã—ãå‹•ä½œã—ã¦ã„ã‚‹ã‹ç¢ºèªï¼š

```bash
curl -X OPTIONS \
  -H "Origin: https://semiemotionally-nonanarchistic-beverley.ngrok-free.dev" \
  -H "Access-Control-Request-Method: POST" \
  -H "Access-Control-Request-Headers: Content-Type,Authorization" \
  -v \
  https://c5nmu4q3di.execute-api.us-east-1.amazonaws.com/dev/auth/verify
```

#### æœŸå¾…ã•ã‚Œã‚‹æˆåŠŸãƒ¬ã‚¹ãƒãƒ³ã‚¹

```
< HTTP/1.1 200 OK
< Access-Control-Allow-Origin: *
< Access-Control-Allow-Methods: POST,OPTIONS
< Access-Control-Allow-Headers: Content-Type,Authorization
```

#### å¤±æ•—æ™‚ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹

```
< HTTP/1.1 404 Not Found
```
ã¾ãŸã¯
```
< HTTP/1.1 403 Forbidden
```
ã¾ãŸã¯ã€CORSãƒ˜ãƒƒãƒ€ãƒ¼ãŒå«ã¾ã‚Œã¦ã„ãªã„

---

### ã‚¹ãƒ†ãƒƒãƒ—2: API Gatewayã®è¨­å®šã‚’ç¢ºèª

#### ç¢ºèªé …ç›®1: `/auth`ãƒªã‚½ãƒ¼ã‚¹ã®å­˜åœ¨

1. AWS API Gatewayã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’é–‹ã
2. å¯¾è±¡ã®REST APIã‚’é¸æŠ
3. å·¦å´ã®ã€Œãƒªã‚½ãƒ¼ã‚¹ã€ã‹ã‚‰ `/auth` ãƒªã‚½ãƒ¼ã‚¹ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
   - âš ï¸ `/auth/verify`ã§ã¯ãªãã€`/auth`ã‚’ç¢ºèª

#### ç¢ºèªé …ç›®2: OPTIONSãƒ¡ã‚½ãƒƒãƒ‰ã®å­˜åœ¨

1. `/auth`ãƒªã‚½ãƒ¼ã‚¹ã‚’é¸æŠ
2. ãƒ¡ã‚½ãƒƒãƒ‰ä¸€è¦§ã«ã€ŒOPTIONSã€ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
   - è¡¨ç¤ºã•ã‚Œã¦ã„ãªã„å ´åˆ â†’ **å•é¡Œ**: OPTIONSãƒ¡ã‚½ãƒƒãƒ‰ãŒä½œæˆã•ã‚Œã¦ã„ãªã„

#### ç¢ºèªé …ç›®3: OPTIONSãƒ¡ã‚½ãƒƒãƒ‰ã®è¨­å®š

OPTIONSãƒ¡ã‚½ãƒƒãƒ‰ãŒå­˜åœ¨ã™ã‚‹å ´åˆï¼š

1. ã€ŒOPTIONSã€ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ã‚¯ãƒªãƒƒã‚¯
2. ã€Œçµ±åˆãƒªã‚¯ã‚¨ã‚¹ãƒˆã€ã‚’ã‚¯ãƒªãƒƒã‚¯
3. ä»¥ä¸‹ã‚’ç¢ºèª:
   - **çµ±åˆã‚¿ã‚¤ãƒ—**: `Lambdaé–¢æ•°` ã¾ãŸã¯ `MOCK`
   - **Lambdaãƒ—ãƒ­ã‚­ã‚·çµ±åˆã‚’ä½¿ç”¨**: âœ… ãƒã‚§ãƒƒã‚¯ãŒå…¥ã£ã¦ã„ã‚‹ï¼ˆLambdaé–¢æ•°ã®å ´åˆï¼‰
   - **Lambdaé–¢æ•°**: `stamp-rally-auth`ï¼ˆLambdaé–¢æ•°ã®å ´åˆï¼‰

#### ç¢ºèªé …ç›®4: CORSè¨­å®šã®ç¢ºèª

1. `/auth`ãƒªã‚½ãƒ¼ã‚¹ã‚’é¸æŠ
2. ã€Œã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã€â†’ã€ŒCORSã‚’æœ‰åŠ¹åŒ–ã€ã‚’ç¢ºèª
   - æ—¢ã«æœ‰åŠ¹åŒ–ã•ã‚Œã¦ã„ã‚‹å ´åˆã€è¨­å®šã‚’ç¢ºèª
   - æœ‰åŠ¹åŒ–ã•ã‚Œã¦ã„ãªã„å ´åˆ â†’ **å•é¡Œ**: CORSãŒæœ‰åŠ¹åŒ–ã•ã‚Œã¦ã„ãªã„

#### ç¢ºèªé …ç›®5: APIã®ãƒ‡ãƒ—ãƒ­ã‚¤çŠ¶æ…‹

1. å³ä¸Šã®ã€Œã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã€â†’ã€ŒAPIã®ãƒ‡ãƒ—ãƒ­ã‚¤ã€ã‚’ç¢ºèª
2. æœ€å¾Œã®ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚åˆ»ã‚’ç¢ºèª
   - CORSè¨­å®šã‚’å¤‰æ›´ã—ãŸå¾Œã€å†ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ã„ãªã„å ´åˆ â†’ **å•é¡Œ**: è¨­å®šãŒåæ˜ ã•ã‚Œã¦ã„ãªã„

---

## âœ… è§£æ±ºæ‰‹é †ï¼ˆå•é¡Œã«å¿œã˜ã¦é¸æŠï¼‰

### å•é¡Œ1: OPTIONSãƒ¡ã‚½ãƒƒãƒ‰ãŒå­˜åœ¨ã—ãªã„

#### è§£æ±ºæ–¹æ³•A: CORSæœ‰åŠ¹åŒ–ã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ï¼ˆæ¨å¥¨ï¼‰

1. `/auth`ãƒªã‚½ãƒ¼ã‚¹ã‚’é¸æŠ
2. ã€Œã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã€â†’ã€ŒCORSã‚’æœ‰åŠ¹åŒ–ã€
3. ä»¥ä¸‹ã®è¨­å®šã‚’å…¥åŠ›:
   ```
   Access-Control-Allow-Origin: *
   Access-Control-Allow-Headers: Content-Type,Authorization
   Access-Control-Allow-Methods: POST,OPTIONS
   ```
4. ã€ŒCORSã‚’æœ‰åŠ¹åŒ–ã—ã¦æ—¢å­˜ã®CORSãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ç½®ãæ›ãˆã‚‹ã€ã‚’ã‚¯ãƒªãƒƒã‚¯
5. ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã§ã€Œã¯ã„ã€æ—¢å­˜ã®å€¤ã‚’ç½®ãæ›ãˆã¾ã™ã€ã‚’ã‚¯ãƒªãƒƒã‚¯

ã“ã‚Œã«ã‚ˆã‚Šã€è‡ªå‹•çš„ã«OPTIONSãƒ¡ã‚½ãƒƒãƒ‰ãŒä½œæˆã•ã‚Œã¾ã™ã€‚

#### è§£æ±ºæ–¹æ³•B: æ‰‹å‹•ã§OPTIONSãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½œæˆ

1. `/auth`ãƒªã‚½ãƒ¼ã‚¹ã‚’é¸æŠ
2. ã€Œã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã€â†’ã€Œãƒ¡ã‚½ãƒƒãƒ‰ã®ä½œæˆã€â†’ã€ŒOPTIONSã€
3. çµ±åˆã‚¿ã‚¤ãƒ—: `Lambdaé–¢æ•°`
4. Lambdaé–¢æ•°: `stamp-rally-auth`
5. **ã€ŒLambdaãƒ—ãƒ­ã‚­ã‚·çµ±åˆã‚’ä½¿ç”¨ã€ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã‚‹**ï¼ˆé‡è¦ï¼‰
6. ã€Œä¿å­˜ã€ã‚’ã‚¯ãƒªãƒƒã‚¯
7. æ¨©é™ã®è¿½åŠ ã‚’æ±‚ã‚ã‚‰ã‚ŒãŸã‚‰ã€ŒOKã€ã‚’ã‚¯ãƒªãƒƒã‚¯

### å•é¡Œ2: CORSè¨­å®šãŒæœ‰åŠ¹åŒ–ã•ã‚Œã¦ã„ãªã„

1. `/auth`ãƒªã‚½ãƒ¼ã‚¹ã‚’é¸æŠ
2. ã€Œã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã€â†’ã€ŒCORSã‚’æœ‰åŠ¹åŒ–ã€
3. è¨­å®šã‚’å…¥åŠ›ï¼ˆä¸Šè¨˜å‚ç…§ï¼‰
4. ã€ŒCORSã‚’æœ‰åŠ¹åŒ–ã—ã¦æ—¢å­˜ã®CORSãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ç½®ãæ›ãˆã‚‹ã€ã‚’ã‚¯ãƒªãƒƒã‚¯

### å•é¡Œ3: APIãŒå†ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¦ã„ãªã„

1. ã€Œã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã€â†’ã€ŒAPIã®ãƒ‡ãƒ—ãƒ­ã‚¤ã€
2. **ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã‚‹ã‚¹ãƒ†ãƒ¼ã‚¸**: `dev` ã‚’é¸æŠ
3. **ãƒ‡ãƒ—ãƒ­ã‚¤ã®èª¬æ˜**: `auth CORSè¨­å®šè¿½åŠ ` ãªã©
4. ã€Œãƒ‡ãƒ—ãƒ­ã‚¤ã€ã‚’ã‚¯ãƒªãƒƒã‚¯
5. ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã™ã‚‹ã¾ã§å¾…ã¤ï¼ˆæ•°ç§’ï¼‰

### å•é¡Œ4: Lambdaãƒ—ãƒ­ã‚­ã‚·çµ±åˆãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ãªã„

1. `/auth`ãƒªã‚½ãƒ¼ã‚¹ â†’ ã€ŒOPTIONSã€ãƒ¡ã‚½ãƒƒãƒ‰ã‚’é¸æŠ
2. ã€Œçµ±åˆãƒªã‚¯ã‚¨ã‚¹ãƒˆã€ã‚’ã‚¯ãƒªãƒƒã‚¯
3. **ã€ŒLambdaãƒ—ãƒ­ã‚­ã‚·çµ±åˆã‚’ä½¿ç”¨ã€ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã‚‹**
4. ã€Œä¿å­˜ã€ã‚’ã‚¯ãƒªãƒƒã‚¯
5. APIã‚’å†ãƒ‡ãƒ—ãƒ­ã‚¤

---

## ğŸ“‹ å®Œå…¨ãªãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### API Gatewayã®è¨­å®š

- [ ] `/auth`ãƒªã‚½ãƒ¼ã‚¹ãŒå­˜åœ¨ã™ã‚‹
- [ ] `/auth`ãƒªã‚½ãƒ¼ã‚¹ã«POSTãƒ¡ã‚½ãƒƒãƒ‰ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹
- [ ] `/auth`ãƒªã‚½ãƒ¼ã‚¹ã«OPTIONSãƒ¡ã‚½ãƒƒãƒ‰ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹
- [ ] OPTIONSãƒ¡ã‚½ãƒƒãƒ‰ã§ã€ŒLambdaãƒ—ãƒ­ã‚­ã‚·çµ±åˆã‚’ä½¿ç”¨ã€ã«ãƒã‚§ãƒƒã‚¯ãŒå…¥ã£ã¦ã„ã‚‹
- [ ] CORSãŒæœ‰åŠ¹åŒ–ã•ã‚Œã¦ã„ã‚‹
- [ ] CORSè¨­å®š:
  - [ ] `Access-Control-Allow-Origin: *`
  - [ ] `Access-Control-Allow-Headers: Content-Type,Authorization`
  - [ ] `Access-Control-Allow-Methods: POST,OPTIONS`
- [ ] APIãŒ`dev`ã‚¹ãƒ†ãƒ¼ã‚¸ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¦ã„ã‚‹

### Lambdaé–¢æ•°ã®ç¢ºèª

- [ ] `stamp-rally-auth` Lambdaé–¢æ•°ãŒå­˜åœ¨ã™ã‚‹
- [ ] Lambdaé–¢æ•°ã«OPTIONSãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å‡¦ç†ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ï¼ˆ`lambda_function.py` 134-136è¡Œç›®ï¼‰
- [ ] `response_utils.py`ã«CORSãƒ˜ãƒƒãƒ€ãƒ¼ãŒå«ã¾ã‚Œã¦ã„ã‚‹ï¼ˆ19-21è¡Œç›®ï¼‰

### å‹•ä½œç¢ºèª

- [ ] curlã‚³ãƒãƒ³ãƒ‰ã§OPTIONSãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒæˆåŠŸã™ã‚‹
- [ ] ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«CORSãƒ˜ãƒƒãƒ€ãƒ¼ãŒå«ã¾ã‚Œã¦ã„ã‚‹
- [ ] ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ã—ãŸ
- [ ] ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ãŸ
- [ ] ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§CORSã‚¨ãƒ©ãƒ¼ãŒè§£æ¶ˆã•ã‚ŒãŸ
- [ ] èªè¨¼ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹

---

## ğŸ§ª ãƒ†ã‚¹ãƒˆã‚³ãƒãƒ³ãƒ‰

### OPTIONSãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãƒ†ã‚¹ãƒˆ

```bash
curl -X OPTIONS \
  -H "Origin: https://semiemotionally-nonanarchistic-beverley.ngrok-free.dev" \
  -H "Access-Control-Request-Method: POST" \
  -H "Access-Control-Request-Headers: Content-Type,Authorization" \
  -v \
  https://c5nmu4q3di.execute-api.us-east-1.amazonaws.com/dev/auth/verify
```

### POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãƒ†ã‚¹ãƒˆï¼ˆèªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ãŒå¿…è¦ï¼‰

```bash
curl -X POST \
  -H "Content-Type: application/json" \
  -H "Origin: https://semiemotionally-nonanarchistic-beverley.ngrok-free.dev" \
  -d '{"id_token":"YOUR_ID_TOKEN"}' \
  -v \
  https://c5nmu4q3di.execute-api.us-east-1.amazonaws.com/dev/auth/verify
```

---

## ğŸš¨ ã‚ˆãã‚ã‚‹é–“é•ã„

### é–“é•ã„1: `/auth/verify`ã§CORSã‚’è¨­å®šã—ã¦ã„ã‚‹

âŒ **é–“é•ã„**: `/auth/verify`ãƒªã‚½ãƒ¼ã‚¹ã§CORSã‚’è¨­å®š
âœ… **æ­£ã—ã„**: `/auth`ãƒªã‚½ãƒ¼ã‚¹ï¼ˆè¦ªãƒªã‚½ãƒ¼ã‚¹ï¼‰ã§CORSã‚’è¨­å®š

### é–“é•ã„2: APIã‚’å†ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ã„ãªã„

âŒ **é–“é•ã„**: CORSè¨­å®šã‚’å¤‰æ›´ã—ãŸãŒã€APIã‚’å†ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ã„ãªã„
âœ… **æ­£ã—ã„**: è¨­å®šå¤‰æ›´å¾Œã€å¿…ãšAPIã‚’å†ãƒ‡ãƒ—ãƒ­ã‚¤

### é–“é•ã„3: Lambdaãƒ—ãƒ­ã‚­ã‚·çµ±åˆã‚’ä½¿ç”¨ã—ã¦ã„ãªã„

âŒ **é–“é•ã„**: OPTIONSãƒ¡ã‚½ãƒƒãƒ‰ã§ã€ŒLambdaãƒ—ãƒ­ã‚­ã‚·çµ±åˆã‚’ä½¿ç”¨ã€ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ã„ãªã„
âœ… **æ­£ã—ã„**: ã€ŒLambdaãƒ—ãƒ­ã‚­ã‚·çµ±åˆã‚’ä½¿ç”¨ã€ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã‚‹

### é–“é•ã„4: ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ã—ã¦ã„ãªã„

âŒ **é–“é•ã„**: è¨­å®šã‚’å¤‰æ›´ã—ãŸãŒã€ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ã—ã¦ã„ãªã„
âœ… **æ­£ã—ã„**: è¨­å®šå¤‰æ›´å¾Œã€ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢

---

## ğŸ“š å‚è€ƒãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [CORSã‚¨ãƒ©ãƒ¼è§£æ±ºæ‰‹é †-å³åº§ã«å®Ÿè¡Œ.md](./CORSã‚¨ãƒ©ãƒ¼è§£æ±ºæ‰‹é †-å³åº§ã«å®Ÿè¡Œ.md) - ç°¡æ˜“ç‰ˆè§£æ±ºæ‰‹é †
- [CORSè¨­å®šä¿®æ­£æ‰‹é †-authé–¢æ•°.md](./CORSè¨­å®šä¿®æ­£æ‰‹é †-authé–¢æ•°.md) - è©³ç´°ãªä¿®æ­£æ‰‹é †
- [CORSã‚¨ãƒ©ãƒ¼è©³ç´°åˆ†æ-authé–¢æ•°.md](./CORSã‚¨ãƒ©ãƒ¼è©³ç´°åˆ†æ-authé–¢æ•°.md) - ã‚¨ãƒ©ãƒ¼ã®è©³ç´°åˆ†æ

---

## ğŸ’¡ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

1. **curlã‚³ãƒãƒ³ãƒ‰ã§OPTIONSãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãƒ†ã‚¹ãƒˆ**
   - æˆåŠŸã™ã‚‹ã‹ç¢ºèª
   - å¤±æ•—ã™ã‚‹å ´åˆã€ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç¢ºèª

2. **API Gatewayã®è¨­å®šã‚’ç¢ºèª**
   - ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã«å¾“ã£ã¦ç¢ºèª

3. **å•é¡Œã‚’ç‰¹å®šã—ã¦è§£æ±º**
   - ä¸Šè¨˜ã®è§£æ±ºæ‰‹é †ã«å¾“ã£ã¦ä¿®æ­£

4. **å†åº¦ãƒ†ã‚¹ãƒˆ**
   - curlã‚³ãƒãƒ³ãƒ‰ã§ç¢ºèª
   - ãƒ–ãƒ©ã‚¦ã‚¶ã§ç¢ºèª

