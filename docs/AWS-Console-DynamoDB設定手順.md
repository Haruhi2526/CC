# AWS Console - DynamoDB設定手順

AWS Consoleを使用してDynamoDBテーブルを作成・設定する手順です。

## 目次

1. [前提条件](#前提条件)
2. [テーブル一覧](#テーブル一覧)
3. [テーブル作成手順](#テーブル作成手順)
4. [各テーブルの詳細設定](#各テーブルの詳細設定)
5. [設定確認](#設定確認)
6. [トラブルシューティング](#トラブルシューティング)

---

## 前提条件

- AWS Consoleにアクセスできること
- DynamoDBへのアクセス権限があること
- 適切なリージョンが選択されていること（例: `us-east-1`）

---

## テーブル一覧

このプロジェクトで使用するDynamoDBテーブルは以下の3つです：

| テーブル名 | パーティションキー | ソートキー | 説明 |
|-----------|------------------|-----------|------|
| **UserStamps** | UserId (String) | StampId (String) | ユーザーのスタンプ収集状況 |
| **StampMasters** | StampId (String) | - | スタンプマスタ情報 |
| **Users** | UserId (String) | - | ユーザー基本情報 |

---

## テーブル作成手順

### 1. AWS Consoleにログイン

1. [AWS Console](https://console.aws.amazon.com/)にログイン
2. 右上のリージョン選択で適切なリージョンを選択（例: `us-east-1`）

### 2. DynamoDBコンソールを開く

1. 検索バーで「DynamoDB」と検索
2. 「DynamoDB」をクリック

### 3. テーブル作成画面を開く

1. 左メニューの「テーブル」をクリック
2. 右上の「テーブルを作成」ボタンをクリック

---

## 各テーブルの詳細設定

### テーブル1: UserStamps

ユーザーのスタンプ収集状況を管理するテーブルです。

#### 基本設定

1. **テーブル名**: `UserStamps`
2. **パーティションキー**: 
   - 属性名: `UserId`
   - 属性タイプ: `String`
3. **ソートキー**:
   - 属性名: `StampId`
   - 属性タイプ: `String`
4. **テーブル設定**: 「デフォルト設定を使用」を選択（後で変更可能）

#### キャパシティモード

- **オンデマンド**: 推奨（使用量に応じて自動スケール）
- **プロビジョンド**: 固定キャパシティを設定する場合

> **推奨**: 開発・テスト環境では「オンデマンド」を選択

#### 追加設定

1. **設定**タブを開く
2. **ポイントインタイムリカバリ (PITR)**: 
   - 「有効化」を推奨（本番環境）
   - 開発環境では「無効化」でも可
3. **タグ**: 必要に応じて追加
   - 例: `Environment: dev`, `Project: CC`

#### スキーマ詳細

| 項目名 | 型 | 必須 | 説明 |
|--------|-----|------|------|
| UserId | String (PK) | ✅ | LINE UID |
| StampId | String (SK) | ✅ | スタンプID |
| CollectedAt | Number | ✅ | 収集日時（Unixタイムスタンプ） |
| Method | String | ✅ | 収集方法（GPS/IMAGE） |
| TTL | Number | - | データ有効期限（削除用、オプション） |

#### 作成手順

1. 「テーブルを作成」画面で以下を入力：
   - テーブル名: `UserStamps`
   - パーティションキー: `UserId` (String)
   - ソートキー: `StampId` (String)
2. 「設定」セクションで「オンデマンド」を選択
3. 「テーブルを作成」ボタンをクリック
4. 作成完了を待つ（通常30秒〜1分）

---

### テーブル2: StampMasters

スタンプマスタ情報を管理するテーブルです。

#### 基本設定

1. **テーブル名**: `StampMasters`
2. **パーティションキー**: 
   - 属性名: `StampId`
   - 属性タイプ: `String`
3. **ソートキー**: なし
4. **テーブル設定**: 「デフォルト設定を使用」を選択

#### キャパシティモード

- **オンデマンド**: 推奨
- **プロビジョンド**: 固定キャパシティを設定する場合

#### 追加設定

1. **設定**タブを開く
2. **ポイントインタイムリカバリ (PITR)**: 
   - 「有効化」を推奨（本番環境）
3. **タグ**: 必要に応じて追加

#### スキーマ詳細

| 項目名 | 型 | 必須 | 説明 |
|--------|-----|------|------|
| StampId | String (PK) | ✅ | スタンプID |
| Name | String | ✅ | スタンプ名 |
| Description | String | - | 説明（オプション） |
| Type | String | ✅ | 収集タイプ（GPS/IMAGE） |
| Location | Map | ✅ | GPS座標（lat, lon, radiusM） |
| ImageLabel | String | - | 画像認識用ラベル（GPSの場合は不要） |
| ValidFrom | Number | - | 有効開始日時（Unixタイムスタンプ、オプション） |
| ValidTo | Number | - | 有効終了日時（Unixタイムスタンプ、オプション） |

#### 作成手順

1. 「テーブルを作成」画面で以下を入力：
   - テーブル名: `StampMasters`
   - パーティションキー: `StampId` (String)
   - ソートキー: なし
2. 「設定」セクションで「オンデマンド」を選択
3. 「テーブルを作成」ボタンをクリック
4. 作成完了を待つ

> **注意**: このテーブルには後でスタンプマスターデータを投入する必要があります。  
> 詳細は「[DynamoDB-スタンプマスターデータ投入手順.md](./DynamoDB-スタンプマスターデータ投入手順.md)」を参照してください。

---

### テーブル3: Users

ユーザー基本情報を管理するテーブルです。

#### 基本設定

1. **テーブル名**: `Users`
2. **パーティションキー**: 
   - 属性名: `UserId`
   - 属性タイプ: `String`
3. **ソートキー**: なし
4. **テーブル設定**: 「デフォルト設定を使用」を選択

#### キャパシティモード

- **オンデマンド**: 推奨
- **プロビジョンド**: 固定キャパシティを設定する場合

#### 追加設定

1. **設定**タブを開く
2. **ポイントインタイムリカバリ (PITR)**: 
   - 「有効化」を推奨（本番環境）
3. **タグ**: 必要に応じて追加

#### スキーマ詳細

| 項目名 | 型 | 必須 | 説明 |
|--------|-----|------|------|
| UserId | String (PK) | ✅ | LINE UID |
| DisplayName | String | ✅ | 表示名 |
| LineId | String | ✅ | LINE ID |
| CreatedAt | Number | ✅ | 登録日時（Unixタイムスタンプ） |
| LastLoginAt | Number | ✅ | 最終ログイン日時（Unixタイムスタンプ） |

#### 作成手順

1. 「テーブルを作成」画面で以下を入力：
   - テーブル名: `Users`
   - パーティションキー: `UserId` (String)
   - ソートキー: なし
2. 「設定」セクションで「オンデマンド」を選択
3. 「テーブルを作成」ボタンをクリック
4. 作成完了を待つ

---

## 設定確認

### 1. テーブル一覧の確認

1. DynamoDBコンソールの「テーブル」メニューを開く
2. 以下の3つのテーブルが作成されていることを確認：
   - `UserStamps`
   - `StampMasters`
   - `Users`

### 2. 各テーブルの詳細確認

各テーブルをクリックして以下を確認：

#### 概要タブ

- **テーブル名**: 正しい名前か確認
- **ARN**: テーブルのARNが表示されているか確認
- **ステータス**: 「アクティブ」になっているか確認
- **キャパシティモード**: 選択したモード（オンデマンド/プロビジョンド）を確認

#### 項目タブ

- パーティションキーとソートキーが正しく設定されているか確認
- テーブルが空であることを確認（データ投入前）

#### 設定タブ

- **ポイントインタイムリカバリ**: 設定した状態を確認
- **タグ**: 追加したタグを確認

### 3. アクセス権限の確認

Lambda関数からアクセスできるように、適切なIAMロールが設定されていることを確認してください。

必要な権限：
- `dynamodb:GetItem`
- `dynamodb:PutItem`
- `dynamodb:UpdateItem`
- `dynamodb:Query`
- `dynamodb:Scan`（必要に応じて）

---

## キャパシティモードの変更

### オンデマンドからプロビジョンドへ変更

1. テーブルを選択
2. 「設定」タブを開く
3. 「キャパシティモード」セクションで「編集」をクリック
4. 「プロビジョンド」を選択
5. 読み取り/書き込みキャパシティユニットを設定
6. 「変更を保存」をクリック

### プロビジョンドからオンデマンドへ変更

1. テーブルを選択
2. 「設定」タブを開く
3. 「キャパシティモード」セクションで「編集」をクリック
4. 「オンデマンド」を選択
5. 「変更を保存」をクリック

> **注意**: モード変更には数分かかる場合があります。

---

## ポイントインタイムリカバリ (PITR) の有効化

### 有効化手順

1. テーブルを選択
2. 「設定」タブを開く
3. 「ポイントインタイムリカバリ」セクションで「編集」をクリック
4. 「有効化」を選択
5. 「変更を保存」をクリック

### 注意事項

- PITRを有効化すると、追加のストレージコストが発生します
- 過去35日間の任意の時点に復元できます
- 本番環境では有効化を推奨します

---

## タグの追加

### タグ追加手順

1. テーブルを選択
2. 「タグ」タブを開く
3. 「タグを管理」をクリック
4. 「タグを追加」をクリック
5. キーと値を入力（例: `Environment: dev`）
6. 「保存」をクリック

### 推奨タグ

- `Environment`: `dev`, `staging`, `prod`
- `Project`: `CC`
- `ManagedBy`: `manual` または `cloudformation`

---

## トラブルシューティング

### テーブルが作成できない

**エラー**: 「テーブル名が既に存在します」

- 解決策: 別のテーブル名を使用するか、既存のテーブルを削除

**エラー**: 「権限が不足しています」

- 解決策: IAMポリシーでDynamoDBの作成権限を確認

### テーブルが「作成中」のまま

- 通常、テーブル作成には30秒〜1分かかります
- 5分以上かかる場合は、AWSサポートに問い合わせ

### パーティションキー/ソートキーの設定ミス

- テーブル作成後はキーの変更ができません
- 誤って作成した場合は、テーブルを削除して再作成してください

### キャパシティモードの変更ができない

- テーブルが「アクティブ」状態であることを確認
- 他の操作が進行中でないことを確認
- 数分待ってから再試行

---

## 次のステップ

テーブル作成後、以下の手順を実行してください：

1. **スタンプマスターデータの投入**
   - `StampMasters`テーブルにデータを投入
   - 詳細は「[DynamoDB-スタンプマスターデータ投入手順.md](./DynamoDB-スタンプマスターデータ投入手順.md)」を参照

2. **Lambda関数の環境変数設定**
   - 各Lambda関数にテーブル名を環境変数として設定
   - 例: `TABLE_USERSTAMPS=UserStamps`
   - 詳細は「[環境変数設定ガイド.md](./環境変数設定ガイド.md)」を参照

3. **IAMロールの設定**
   - Lambda関数にDynamoDBへのアクセス権限を付与

4. **動作確認**
   - Lambda関数からテーブルへの読み書きが正常に動作するか確認

---

## 参考情報

### DynamoDBの料金

- **オンデマンド**: 使用した分だけ課金（$1.25/100万回の読み書き）
- **プロビジョンド**: 固定キャパシティを設定（$0.00065/読み取りユニット/時間）

詳細は[AWS DynamoDB料金ページ](https://aws.amazon.com/jp/dynamodb/pricing/)を参照してください。

### 制限事項

- テーブル名: 3〜255文字、英数字とハイフン(-)、アンダースコア(_)のみ
- パーティションキー: 最大400KB
- アイテムサイズ: 最大400KB

---

**更新日**: 2025年1月

