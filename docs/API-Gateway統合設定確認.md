# API Gateway統合設定の確認手順

## 問題: リクエストボディがLambda関数に届かない

### 症状
- フロントエンドからは正しくリクエストボディが送信されている
- しかし、Lambda関数では「id_token is required」エラーが返される

### 原因
API Gatewayの統合設定で「Lambdaプロキシ統合」が有効になっていない可能性があります。

---

## 解決方法

### 手順1: API Gatewayコンソールを開く

1. AWSコンソールで「API Gateway」を検索
2. 対象のREST APIを選択（例: 作成したAPI）
3. 「リソース」から `/auth` → `/verify` または `/auth` リソースを選択
4. POSTメソッドを選択

### 手順2: Lambdaプロキシ統合を確認・有効化

1. POSTメソッドを選択
2. 「統合リクエスト」をクリック
3. **統合タイプ**: `Lambda関数` を確認
4. **Lambdaプロキシ統合を使用**: ✅ **チェックを入れる（重要！）**

**重要**: 「Lambdaプロキシ統合を使用」にチェックが入っていることを確認してください。

チェックが入っていない場合:
- Lambda関数は`event.body`を文字列として受け取れません
- リクエストボディが正しく渡されません

### 手順3: 統合リクエストの設定確認

「統合リクエスト」画面で以下を確認:

- **統合タイプ**: Lambda関数
- **Lambdaプロキシ統合を使用**: ✅ チェック済み
- **Lambda関数**: `stamp-rally-auth`（または作成した関数名）
- **Lambdaリージョン**: 関数が作成されているリージョン

### 手順4: 設定を保存

1. 「保存」をクリック
2. 権限の追加を求められたら「OK」をクリック

### 手順5: APIの再デプロイ

**重要**: 設定変更後は必ずAPIを再デプロイする必要があります。

1. 「アクション」→「APIのデプロイ」
2. **デプロイされるステージ**: `dev` または対象のステージを選択
3. 「デプロイ」をクリック

---

## Lambdaプロキシ統合とは

### 有効にしている場合（推奨）

Lambda関数が受け取る`event`オブジェクト:
```json
{
  "httpMethod": "POST",
  "body": "{\"id_token\":\"...\"}",  // 文字列として受け取る
  "headers": {...},
  "pathParameters": null,
  "queryStringParameters": null
}
```

Lambda関数では`json.loads(event.get('body', '{}'))`でパースします。

### 無効にしている場合（問題）

Lambda関数が受け取る`event`オブジェクトはAPI Gatewayの形式に依存し、リクエストボディが正しく渡されない可能性があります。

---

## 確認手順

### 1. API Gatewayコンソールでの確認

1. POSTメソッド → 「統合リクエスト」
2. 「Lambdaプロキシ統合を使用」にチェックが入っているか確認

### 2. テスト実行

API Gatewayコンソールで直接テスト:

1. POSTメソッドを選択
2. 「テスト」をクリック
3. **リクエスト本文**: 
   ```json
   {"id_token": "test_token_12345"}
   ```
4. 「テスト」ボタンをクリック
5. レスポンスを確認

**成功時のレスポンス例**:
```json
{
  "statusCode": 200,
  "body": "{\"ok\":true,\"user_id\":\"...\",\"display_name\":\"...\",\"access_token\":\"...\"}"
}
```

---

## トラブルシューティング

### 問題1: 「Lambdaプロキシ統合を使用」のオプションが見つからない

**原因**: API Gatewayのバージョンや設定によって表示が異なる場合があります。

**対処法**:
- 「統合タイプ」で「Lambda関数」を選択していることを確認
- 「統合エンドポイント」セクションで「Lambdaプロキシ統合」のオプションを探す

### 問題2: 設定を変更しても動作しない

**原因**: APIの再デプロイをしていない

**対処法**:
1. 「アクション」→「APIのデプロイ」
2. ステージを選択して再デプロイ

### 問題3: Lambda関数で`event.body`が`None`になる

**原因**: Lambdaプロキシ統合が無効になっている

**対処法**:
1. 「統合リクエスト」で「Lambdaプロキシ統合を使用」にチェック
2. APIを再デプロイ

---

## 参考リンク

- [API Gateway Lambda プロキシ統合](https://docs.aws.amazon.com/ja_jp/apigateway/latest/developerguide/set-up-lambda-proxy-integrations.html)

---

**重要**: Lambdaプロキシ統合を有効にしたら、必ずAPIを再デプロイしてください！

