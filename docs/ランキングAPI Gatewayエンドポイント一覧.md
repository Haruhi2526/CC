# ãƒ©ãƒ³ã‚­ãƒ³ã‚°é–¢é€£ API Gateway ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä¸€è¦§

**ä½œæˆæ—¥**: 2025å¹´1æœˆ  
**ãƒ™ãƒ¼ã‚¹URL**: `https://2bm71jvfs6.execute-api.us-east-1.amazonaws.com/dev`

---

## ğŸ“‹ ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä¸€è¦§

### ãƒ©ãƒ³ã‚­ãƒ³ã‚°é–¢é€£ï¼ˆranking Lambdaé–¢æ•°ï¼‰

#### 1. POST /ranking/calculate
ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’è¨ˆç®—ã—ã¦DynamoDBã«ä¿å­˜

**ãƒ¡ã‚½ãƒƒãƒ‰**: `POST`  
**Lambdaé–¢æ•°**: `ranking`  
**ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿**:
- `type`: `weekly` ã¾ãŸã¯ `monthly`ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: `weekly`ï¼‰

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¾‹**:
```bash
curl -X POST "https://2bm71jvfs6.execute-api.us-east-1.amazonaws.com/dev/ranking/calculate?type=weekly"
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹**:
```json
{
  "ok": true,
  "period": "2025-W45",
  "period_type": "weekly",
  "rankings_count": 10
}
```

**æ³¨æ„**: é€±é–“ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã¯ä»Šé€±ã®æœˆæ›œæ—¥0æ™‚00åˆ†00ç§’ã‹ã‚‰ã€æœˆé–“ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã¯ä»Šæœˆã®1æ—¥0æ™‚00åˆ†00ç§’ã‹ã‚‰ã®ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ã‚«ã‚¦ãƒ³ãƒˆã—ã¾ã™ã€‚

---

#### 2. GET /ranking/friends/weekly
å‹é”ã®é€±é–“ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’å–å¾—ï¼ˆè‡ªåˆ†è‡ªèº«ã‚‚å«ã‚€ï¼‰

**ãƒ¡ã‚½ãƒƒãƒ‰**: `GET`  
**Lambdaé–¢æ•°**: `ranking`  
**ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿**:
- `user_id`: ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆå¿…é ˆï¼‰
- `period`: æœŸé–“æ–‡å­—åˆ—ï¼ˆä¾‹: `2025-W46`ã€çœç•¥æ™‚ã¯ç¾åœ¨ã®é€±ï¼‰

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¾‹**:
```bash
curl -X GET "https://2bm71jvfs6.execute-api.us-east-1.amazonaws.com/dev/ranking/friends/weekly?user_id=U1234567890"
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹**:
```json
{
  "ok": true,
  "period": "2025-W46",
  "period_type": "weekly",
  "rankings": [
    {
      "rank": 1,
      "user_id": "U1234567890...",
      "stamp_count": 15,
      "display_name": "ãƒ¦ãƒ¼ã‚¶ãƒ¼1",
      "is_self": true
    },
    {
      "rank": 2,
      "user_id": "U0987654321...",
      "stamp_count": 12,
      "display_name": "å‹é”1",
      "is_self": false
    }
  ]
}
```

**æ³¨æ„**: 
- å‹é”ãƒªã‚¹ãƒˆã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹å‹é”ã¨è‡ªåˆ†è‡ªèº«ãŒãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«å«ã¾ã‚Œã¾ã™
- `is_self`ãƒ•ãƒ©ã‚°ã§è‡ªåˆ†è‡ªèº«ã‹ã©ã†ã‹ã‚’åˆ¤åˆ¥ã§ãã¾ã™

---

#### 3. GET /ranking/friends/monthly
å‹é”ã®æœˆé–“ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’å–å¾—ï¼ˆè‡ªåˆ†è‡ªèº«ã‚‚å«ã‚€ï¼‰

**ãƒ¡ã‚½ãƒƒãƒ‰**: `GET`  
**Lambdaé–¢æ•°**: `ranking`  
**ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿**:
- `user_id`: ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆå¿…é ˆï¼‰
- `period`: æœŸé–“æ–‡å­—åˆ—ï¼ˆä¾‹: `2025-11`ã€çœç•¥æ™‚ã¯ç¾åœ¨ã®æœˆï¼‰

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¾‹**:
```bash
curl -X GET "https://2bm71jvfs6.execute-api.us-east-1.amazonaws.com/dev/ranking/friends/monthly?user_id=U1234567890"
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹**:
```json
{
  "ok": true,
  "period": "2025-11",
  "period_type": "monthly",
  "rankings": [
    {
      "rank": 1,
      "user_id": "U1234567890...",
      "stamp_count": 50,
      "display_name": "ãƒ¦ãƒ¼ã‚¶ãƒ¼1",
      "is_self": true
    },
    {
      "rank": 2,
      "user_id": "U0987654321...",
      "stamp_count": 45,
      "display_name": "å‹é”1",
      "is_self": false
    }
  ]
}
```

**æ³¨æ„**: 
- å‹é”ãƒªã‚¹ãƒˆã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹å‹é”ã¨è‡ªåˆ†è‡ªèº«ãŒãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«å«ã¾ã‚Œã¾ã™
- `is_self`ãƒ•ãƒ©ã‚°ã§è‡ªåˆ†è‡ªèº«ã‹ã©ã†ã‹ã‚’åˆ¤åˆ¥ã§ãã¾ã™

---

#### 4. GET /ranking/compare
2äººã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ¯”è¼ƒ

**ãƒ¡ã‚½ãƒƒãƒ‰**: `GET`  
**Lambdaé–¢æ•°**: `ranking`  
**ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿**:
- `user_id`: ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆå¿…é ˆï¼‰
- `friend_id`: å‹é”ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆå¿…é ˆï¼‰

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¾‹**:
```bash
curl -X GET "https://2bm71jvfs6.execute-api.us-east-1.amazonaws.com/dev/ranking/compare?user_id=U1234567890&friend_id=U0987654321"
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹**:
```json
{
  "ok": true,
  "user": {
    "user_id": "U1234567890...",
    "display_name": "ãƒ¦ãƒ¼ã‚¶ãƒ¼1",
    "stamp_count": 15
  },
  "friend": {
    "user_id": "U0987654321...",
    "display_name": "ãƒ¦ãƒ¼ã‚¶ãƒ¼2",
    "stamp_count": 12
  },
  "rank_diff": 3,
  "user_is_higher": true
}
```

---

### å‹é”é–¢é€£ï¼ˆfriends Lambdaé–¢æ•°ï¼‰

#### 7. POST /friends/add
å‹é”é–¢ä¿‚ã‚’è¿½åŠ ï¼ˆåŒæ–¹å‘ï¼‰

**ãƒ¡ã‚½ãƒƒãƒ‰**: `POST`  
**Lambdaé–¢æ•°**: `friends`  
**ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£**:
```json
{
  "user_id": "U1234567890...",
  "friend_id": "U0987654321..."
}
```

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¾‹**:
```bash
curl -X POST "https://2bm71jvfs6.execute-api.us-east-1.amazonaws.com/dev/friends/add" \
  -H "Content-Type: application/json" \
  -d '{
    "user_id": "U1234567890",
    "friend_id": "U0987654321"
  }'
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹**:
```json
{
  "ok": true,
  "message": "Friend relationship added successfully",
  "user_id": "U1234567890...",
  "friend_id": "U0987654321..."
}
```

---

#### 8. GET /friends/list
å‹é”ãƒªã‚¹ãƒˆã‚’å–å¾—

**ãƒ¡ã‚½ãƒƒãƒ‰**: `GET`  
**Lambdaé–¢æ•°**: `friends`  
**ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿**:
- `user_id`: ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆå¿…é ˆï¼‰

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¾‹**:
```bash
curl -X GET "https://2bm71jvfs6.execute-api.us-east-1.amazonaws.com/dev/friends/list?user_id=U1234567890"
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹**:
```json
{
  "ok": true,
  "user_id": "U1234567890...",
  "friends": [
    {
      "friend_id": "U0987654321...",
      "created_at": 1234567890
    }
  ],
  "count": 1
}
```

---

## ğŸ”§ API Gatewayè¨­å®š

### ãƒªã‚½ãƒ¼ã‚¹æ§‹é€ 

```
/ranking
  â”œâ”€â”€ /calculate (POST)
  â”œâ”€â”€ /compare (GET)
  â””â”€â”€ /friends
      â”œâ”€â”€ /weekly (GET)
      â””â”€â”€ /monthly (GET)

/friends
  â”œâ”€â”€ /add (POST)
  â””â”€â”€ /list (GET)
```

**æ³¨æ„**: `/ranking/weekly` ã¨ `/ranking/monthly` ã¯å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚å‹é”ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã®ã¿ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚

### è¨­å®šæ‰‹é †

1. **ãƒªã‚½ãƒ¼ã‚¹ã®ä½œæˆ**
   - `/ranking` ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆ
   - `/ranking/calculate` ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆ
   - `/ranking/compare` ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
   - `/ranking/friends` ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆ
   - `/ranking/friends/weekly` ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆ
   - `/ranking/friends/monthly` ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆ
   - `/friends` ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆ
   - `/friends/add` ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆ
   - `/friends/list` ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆ

2. **ãƒ¡ã‚½ãƒƒãƒ‰ã®è¨­å®š**
   - å„ãƒªã‚½ãƒ¼ã‚¹ã«é©åˆ‡ãªHTTPãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆGET/POSTï¼‰ã‚’è¿½åŠ 
   - Lambdaçµ±åˆã‚’è¨­å®šï¼ˆãƒ—ãƒ­ã‚­ã‚·çµ±åˆã‚’æœ‰åŠ¹åŒ–ï¼‰

3. **CORSè¨­å®š**
   - ã™ã¹ã¦ã®ãƒ¡ã‚½ãƒƒãƒ‰ã§CORSã‚’æœ‰åŠ¹åŒ–
   - è¨±å¯ã™ã‚‹ã‚ªãƒªã‚¸ãƒ³: `*`ï¼ˆæœ¬ç•ªç’°å¢ƒã§ã¯é©åˆ‡ãªã‚ªãƒªã‚¸ãƒ³ã‚’æŒ‡å®šï¼‰
   - è¨±å¯ã™ã‚‹ãƒ˜ãƒƒãƒ€ãƒ¼: `Content-Type,Authorization`
   - è¨±å¯ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰: `GET,POST,OPTIONS`

---

## ğŸ“Š ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä¸€è¦§è¡¨

| ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ | ãƒ¡ã‚½ãƒƒãƒ‰ | Lambdaé–¢æ•° | èª¬æ˜ |
|-------------|---------|-----------|------|
| `/ranking/calculate` | POST | ranking | ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¨ˆç®— |
| `/ranking/friends/weekly` | GET | ranking | å‹é”é€±é–“ãƒ©ãƒ³ã‚­ãƒ³ã‚°å–å¾—ï¼ˆè‡ªåˆ†è‡ªèº«ã‚‚å«ã‚€ï¼‰ |
| `/ranking/friends/monthly` | GET | ranking | å‹é”æœˆé–“ãƒ©ãƒ³ã‚­ãƒ³ã‚°å–å¾—ï¼ˆè‡ªåˆ†è‡ªèº«ã‚‚å«ã‚€ï¼‰ |
| `/ranking/compare` | GET | ranking | ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¯”è¼ƒ |
| `/friends/add` | POST | friends | å‹é”é–¢ä¿‚ã‚’è¿½åŠ  |
| `/friends/list` | GET | friends | å‹é”ãƒªã‚¹ãƒˆã‚’å–å¾— |

**æ³¨æ„**: 
- `/ranking/weekly` ã¨ `/ranking/monthly` ã¯å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã›ã‚“
- ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤ºã«ã¯ `/ranking/friends/weekly` ã¨ `/ranking/friends/monthly` ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„
- å‹é”ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«ã¯ã€å‹é”ãƒªã‚¹ãƒˆã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹å‹é”ã¨è‡ªåˆ†è‡ªèº«ãŒå«ã¾ã‚Œã¾ã™

---

## ğŸ” èªè¨¼ãƒ»èªå¯

ç¾åœ¨ã®å®Ÿè£…ã§ã¯ã€èªè¨¼ã¯ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§è¡Œã„ã€`user_id`ã‚’ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¾ãŸã¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã§é€ä¿¡ã—ã¾ã™ã€‚

å°†æ¥çš„ã«ã¯ã€ä»¥ä¸‹ã®æ”¹å–„ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ï¼š
- JWTãƒˆãƒ¼ã‚¯ãƒ³ã«ã‚ˆã‚‹èªè¨¼
- API Gatewayã®èªè¨¼æ©Ÿèƒ½ã‚’ä½¿ç”¨
- ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®`user_id`ã¨ãƒˆãƒ¼ã‚¯ãƒ³ã®`user_id`ã‚’æ¤œè¨¼

---

## âš ï¸ æ³¨æ„äº‹é …

1. **CORSè¨­å®š**
   - ã™ã¹ã¦ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§CORSã‚’æœ‰åŠ¹åŒ–ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™
   - æœ¬ç•ªç’°å¢ƒã§ã¯ã€è¨±å¯ã™ã‚‹ã‚ªãƒªã‚¸ãƒ³ã‚’é©åˆ‡ã«è¨­å®šã—ã¦ãã ã•ã„

2. **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**
   - ã™ã¹ã¦ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã—ã¾ã™
   - ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å«ã‚€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã—ã¾ã™

3. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**
   - ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¨ˆç®—ã¯æ™‚é–“ãŒã‹ã‹ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™
   - ãƒãƒƒãƒå‡¦ç†ï¼ˆEventBridgeï¼‰ã§ã®å®šæœŸå®Ÿè¡Œã‚’æ¨å¥¨ã—ã¾ã™

---

**æœ€çµ‚æ›´æ–°**: 2025å¹´1æœˆ

