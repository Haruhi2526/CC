# ランキング表示されない問題の解決方法

**作成日**: 2025年1月  
**問題**: Friendsテーブルに情報は追加されたが、フロントエンド上にランキングが表示されない

---

## 🔍 問題の分析

### ログから分かること

```
📊 ランキングAPIレスポンス: {ok: true, period: '2025-W46', period_type: 'weekly', rankings: Array(0)}
📊 rankings.length: 0
```

- APIは正常に動作している（`ok: true`）
- しかし、ランキングデータが空（`rankings: Array(0)`）

### 考えられる原因

1. **Rankingsテーブルにデータがない**
   - ランキング計算が実行されていない
   - 友達がスタンプを集めていない

2. **期間の不一致**
   - 現在の週（2025-W46）のランキングデータが存在しない

3. **友達がランキングに含まれていない**
   - 友達がスタンプを集めていない
   - ランキング計算時に友達が含まれていない

---

## ✅ 解決方法

### 方法1: ランキング計算を実行する

ランキングデータを生成するために、ランキング計算APIを呼び出します。

#### curlコマンドで実行

```bash
# 週間ランキングを計算
curl -X POST "https://2bm71jvfs6.execute-api.us-east-1.amazonaws.com/dev/ranking/calculate?type=weekly"

# 月間ランキングを計算
curl -X POST "https://2bm71jvfs6.execute-api.us-east-1.amazonaws.com/dev/ranking/calculate?type=monthly"
```

#### API Gatewayコンソールで実行

1. API Gatewayコンソールを開く
2. `/ranking/calculate` リソース → POSTメソッドを選択
3. 「テスト」をクリック
4. **クエリ文字列**: `type=weekly`
5. 「テスト」ボタンをクリック
6. レスポンスを確認

**成功時のレスポンス例**:
```json
{
  "ok": true,
  "period": "2025-W46",
  "period_type": "weekly",
  "rankings_count": 10
}
```

### 方法2: CloudWatch LogsでLambda関数のログを確認

1. **AWS Lambdaコンソールを開く**
2. **`ranking` 関数を選択**
3. **「モニタリング」タブ → 「CloudWatch Logsの表示」をクリック**
4. **最新のログストリームを開く**
5. **以下のログを確認**:
   - `友達リスト取得: user_id=..., 友達数=...`
   - `アクティブな友達数: ...`
   - `全体ランキング件数: ...`
   - `友達ランキング件数: ...`

#### 確認ポイント

- **友達数が0の場合**: Friendsテーブルにデータが正しく保存されていない
- **全体ランキング件数が0の場合**: Rankingsテーブルにデータがない（ランキング計算が必要）
- **友達ランキング件数が0の場合**: 友達がランキングに含まれていない（友達がスタンプを集めていない可能性）

### 方法3: DynamoDBテーブルを直接確認

#### Friendsテーブルの確認

1. **DynamoDBコンソールを開く**
2. **`Friends` テーブルを選択**
3. **「項目を探索」をクリック**
4. **自分の`UserId`で検索**
5. **友達が正しく保存されているか確認**

#### Rankingsテーブルの確認

1. **DynamoDBコンソールを開く**
2. **`Rankings` テーブルを選択**
3. **「項目を探索」をクリック**
4. **`Period` で検索**: `weekly-2025-W46`（現在の週）
5. **ランキングデータが存在するか確認**

---

## 🔧 トラブルシューティング

### 問題1: ランキング計算を実行してもデータが生成されない

**確認事項**:
1. UserStampsテーブルにスタンプデータが存在するか
2. 期間内（週間/月間）のスタンプデータが存在するか
3. Lambda関数のIAMロールにDynamoDB読み書き権限があるか

### 問題2: 友達がランキングに表示されない

**確認事項**:
1. Friendsテーブルに友達関係が正しく保存されているか
2. 友達がスタンプを集めているか
3. ランキング計算が実行されているか
4. 期間が一致しているか

### 問題3: ランキング計算がエラーになる

**確認事項**:
1. Lambda関数のログを確認
2. DynamoDBテーブルが存在するか
3. IAMロールの権限が正しいか

---

## 📝 推奨される手順

1. **ランキング計算を実行**
   ```bash
   curl -X POST "https://2bm71jvfs6.execute-api.us-east-1.amazonaws.com/dev/ranking/calculate?type=weekly"
   ```

2. **CloudWatch LogsでLambda関数のログを確認**
   - 友達リストが正しく取得されているか
   - ランキングデータが正しく取得されているか

3. **フロントエンドを再読み込み**
   - ブラウザのキャッシュをクリア
   - ページを再読み込み

4. **ブラウザのコンソールでログを確認**
   - ランキングAPIレスポンスを確認
   - ランキングデータの件数を確認

---

## ⚠️ 注意事項

- **ランキング計算は定期的に実行する必要があります**
  - 週間ランキング: 毎週実行
  - 月間ランキング: 毎月実行
  - EventBridge（CloudWatch Events）で自動実行することを推奨

- **友達がスタンプを集めていない場合、ランキングに表示されません**
  - 友達がスタンプを集める必要があります
  - ランキング計算を実行する必要があります

---

**最終更新**: 2025年1月

