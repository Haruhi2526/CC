# リッチメニュー トラブルシューティング

**作成日**: 2025年11月

---

## ❌ よくあるエラーと解決方法

### エラー1: `{"richmenus": []}` - リッチメニュー一覧が空

**症状:**
```json
{"richmenus": []}
```

**原因:**
- LINE Developers Consoleでリッチメニューが作成されていない
- リッチメニューが作成されていても、公開されていない

**解決方法:**

1. **LINE Developers Consoleで確認**
   - https://developers.line.biz/console/ にログイン
   - 対象チャネルを選択
   - 「リッチメニュー」タブを開く
   - リッチメニューが存在するか確認

2. **リッチメニューを作成・公開**
   - リッチメニューが存在しない場合: 「作成」ボタンで作成
   - リッチメニューが存在する場合: 「公開」ボタンをクリック
   - **重要**: リッチメニューは公開しないとIDが発行されません

3. **公開後の確認**
   ```bash
   curl -X GET \
     'https://{API_GATEWAY_URL}/dev/richmenu/list' \
     -H 'Content-Type: application/json'
   ```
   - 公開後は `richmenus` 配列にリッチメニュー情報が含まれます

---

### エラー2: `"Not found"` - リッチメニューが見つからない

**症状:**
```json
{
  "error": "Error",
  "message": "Not found",
  "error_code": "LINE_API_ERROR"
}
```

**原因:**
1. リッチメニューIDが間違っている
2. リッチメニューが存在しない、または削除されている
3. リッチメニューIDの形式が正しくない

**解決方法:**

#### Step 1: リッチメニューIDの確認

正しいリッチメニューIDを取得する:

```bash
# リッチメニュー一覧を取得
curl -X GET \
  'https://{API_GATEWAY_URL}/dev/richmenu/list' \
  -H 'Content-Type: application/json'
```

**レスポンス例:**
```json
{
  "richmenus": [
    {
      "richMenuId": "richmenu-1234567890abcdef",  // ← これが正しいID
      "name": "メインメニュー",
      ...
    }
  ]
}
```

#### Step 2: リッチメニューIDの形式確認

**正しい形式の例:**
- `richmenu-1234567890abcdef` ✅
- `richmenu-abc123def456` ✅

**間違った形式の例:**
- `18040549` ❌ (数字のみ)
- `richmenu` ❌ (`richmenu-` の後の部分がない)

**注意**: 一部のケースでは数字のみのIDも有効ですが、通常は `richmenu-` で始まる形式です。

#### Step 3: 正しいIDで再実行

```bash
curl -X POST \
  'https://{API_GATEWAY_URL}/dev/richmenu/set' \
  -H 'Content-Type: application/json' \
  -d '{
    "user_id": "Ubb2550980506cc932bf7a8fa7f372ec1",
    "richmenu_id": "richmenu-1234567890abcdef"  // ← 正しいIDを使用
  }'
```

---

### エラー3: `401 Unauthorized`

**症状:**
```json
{
  "error": "Error",
  "message": "401 Unauthorized",
  "error_code": "LINE_API_ERROR"
}
```

**原因:**
- Channel Access Tokenが無効または期限切れ
- 環境変数が正しく設定されていない

**解決方法:**

1. **Lambda関数の環境変数を確認**
   - AWS Lambda Consoleで `richmenu` 関数を開く
   - 「設定」→「環境変数」を確認
   - `LINE_CHANNEL_ACCESS_TOKEN` が設定されているか確認

2. **新しいトークンを発行**
   - LINE Developers Consoleにログイン
   - 「Messaging API」タブを開く
   - 「チャンネルアクセストークン（長期）」を再発行
   - 新しいトークンをLambda関数の環境変数に設定

3. **環境変数の更新**
   - Lambda関数の環境変数を編集
   - 新しいトークンを貼り付けて保存

---

### エラー4: ユーザーIDが無効

**症状:**
```json
{
  "error": "Error",
  "message": "The user ID provided is invalid",
  "error_code": "LINE_API_ERROR"
}
```

**原因:**
- ユーザーIDの形式が間違っている
- ユーザーが公式アカウントを友達登録していない

**解決方法:**

1. **ユーザーIDの形式確認**
   - 正しい形式: `U` で始まる文字列（例: `Ubb2550980506cc932bf7a8fa7f372ec1`）
   - LIFFアプリから取得したIDを使用

2. **友達登録の確認**
   - ユーザーが公式アカウントを友達登録しているか確認
   - 友達登録していない場合、リッチメニューは表示されません

---

## 🔍 デバッグ方法

### 1. CloudWatch Logsで確認

Lambda関数のログを確認:

1. AWS Lambda Consoleで `richmenu` 関数を開く
2. 「モニタリング」タブ → 「CloudWatch Logsでログを表示」
3. 最新のログストリームを開く
4. エラーメッセージとリクエスト/レスポンスの詳細を確認

**確認ポイント:**
- リクエストされたURL
- LINE APIからのレスポンス
- エラーメッセージの詳細

### 2. LINE Developers Consoleで確認

リッチメニューの状態を確認:

1. LINE Developers Consoleにログイン
2. 対象チャネルを選択
3. 「リッチメニュー」タブを開く
4. 各リッチメニューの状態を確認:
   - **作成中**: まだ公開されていない
   - **公開中**: 公開されている（使用可能）
   - **無効**: 削除されている

### 3. curlで直接LINE APIを呼び出す

Lambda関数を経由せず、直接LINE APIをテスト:

```bash
# チャンネルアクセストークンを設定
export ACCESS_TOKEN="YOUR_CHANNEL_ACCESS_TOKEN"

# リッチメニュー一覧を取得
curl -X GET \
  'https://api.line.me/v2/bot/richmenu/list' \
  -H "Authorization: Bearer $ACCESS_TOKEN"

# リッチメニューを設定
curl -X POST \
  "https://api.line.me/v2/bot/user/Ubb2550980506cc932bf7a8fa7f372ec1/richmenu/richmenu-1234567890abcdef" \
  -H "Authorization: Bearer $ACCESS_TOKEN"
```

---

## 📋 チェックリスト

リッチメニューが動作しない場合、以下を確認してください:

- [ ] LINE Developers Consoleでリッチメニューが作成されている
- [ ] リッチメニューが「公開」されている（公開中である）
- [ ] リッチメニューIDが正しい（`/richmenu/list` で確認）
- [ ] Lambda関数の環境変数 `LINE_CHANNEL_ACCESS_TOKEN` が設定されている
- [ ] Channel Access Tokenが有効である（期限切れでない）
- [ ] ユーザーIDが正しい形式である（`U` で始まる）
- [ ] ユーザーが公式アカウントを友達登録している
- [ ] API Gatewayのエンドポイントが正しい

---

## 🔗 参考リンク

- [LINE Messaging API - リッチメニュー](https://developers.line.biz/ja/docs/messaging-api/using-rich-menus/)
- [リッチメニューAPI リファレンス](https://developers.line.biz/ja/reference/messaging-api/#rich-menu)
- [リッチメニュー実装手順.md](./リッチメニュー実装手順.md)
- [リッチメニューIDについて.md](./リッチメニューIDについて.md)

---

**最終更新**: 2025年11月

