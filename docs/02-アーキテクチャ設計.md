# アーキテクチャ設計

## 2.1 システム構成図

```
┌─────────────────────────────────────────────────────────────┐
│                        LIFF フロントエンド                      │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐       │
│  │  スタンプ一覧  │  │   GPS画面    │  │ 写真撮影画面 │       │
│  └──────────────┘  └──────────────┘  └──────────────┘       │
└─────────────────────────────────────────────────────────────┘
                           │
                           │ HTTPS
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                    AWS API Gateway                            │
│                   (認証・ルーティング)                         │
└─────────────────────────────────────────────────────────────┘
                           │
        ┌──────────────────┼──────────────────┐
        │                  │                  │
        ▼                  ▼                  ▼
┌──────────────┐  ┌──────────────┐  ┌──────────────┐
│  Lambda Fn1  │  │  Lambda Fn2  │  │  Lambda Fn3  │
│ スタンプ取得  │  │ 位置情報検証  │  │ 画像認識処理  │
└──────────────┘  └──────────────┘  └──────────────┘
        │                  │                  │
        │                  │                  │
        ▼                  ▼                  ▼
┌─────────────────────────────────────────────────────────────┐
│                      DynamoDB                                 │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐       │
│  │  ユーザーデータ│  │ スタンプマスタ│  │ 収集履歴     │       │
│  └──────────────┘  └──────────────┘  └──────────────┘       │
└─────────────────────────────────────────────────────────────┘

                          │
                          ▼
              ┌───────────────────────────┐
              │   Amazon Rekognition       │
              │   (画像認識サービス)       │
              └───────────────────────────┘
                          │
                          ▼
              ┌───────────────────────────┐
              │   Amazon S3                │
              │   (画像ストレージ)         │
              └───────────────────────────┘
```

## 2.2 主要AWSサービスの選定理由

| サービス | 用途 | 選定理由 |
|---------|------|---------|
| **API Gateway** | APIエンドポイント | RESTful APIの構築、認証管理 |
| **Lambda** | サーバーレス関数実行 | コスト効率、自動スケーリング、メンテナンス不要 |
| **DynamoDB** | NoSQLデータベース | 高速な読み書き、スケーラビリティ、フルマネージド |
| **Rekognition** | AI画像認識 | 高精度な物体認識、カスタムラベル検出 |
| **S3** | オブジェクトストレージ | 画像データの保存、高可用性 |
| **Cognito** | 認証・認可 | ユーザー管理、セキュリティトークン発行 |

## 2.3 データフロー

### GPSベースのスタンプ収集フロー
1. ユーザーがアプリを開き、GPS位置情報を送信
2. API Gatewayがリクエストを受信
3. Lambda関数が位置情報を検証（目標地点からの距離計算）
4. 100m以内ならDynamoDBにスタンプ情報を登録
5. 結果をフロントエンドに返却

### 画像認識ベースのスタンプ収集フロー
1. ユーザーがカメラで写真を撮影
2. 画像をBase64エンコードしてAPIに送信
3. Lambda関数がS3に画像をアップロード
4. Amazon Rekognitionで画像認識を実行
5. 正解判定後、DynamoDBにスタンプ情報を登録
6. 結果をフロントエンドに返却

