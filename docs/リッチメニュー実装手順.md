# リッチメニュー実装手順

**作成日**: 2025年11月  
**対象**: Phase 1 - リッチメニュー機能実装

---

## 📋 概要

LINEアプリの下部に表示されるリッチメニューを実装します。ユーザーはメニューから主要機能に素早くアクセスできます。

---

## 🎯 実装ステップ

### Step 1: LINE Developers Console設定

#### 1.1 リッチメニューの作成

1. **LINE Developers Consoleにアクセス**
   - https://developers.line.biz/console/ にログイン
   - 対象のチャネルを選択

2. **Messaging API設定を確認**
   - 「Messaging API」タブを開く
   - 「Channel access token」を発行（未発行の場合）
   - トークンをメモ（後でAWS環境変数に設定）

3. **リッチメニューの作成**
   - 左メニューから「リッチメニュー」を選択
   - 「作成」ボタンをクリック

#### 1.2 リッチメニューのデザイン

**メニュー構造例（通常時）:**

```
┌─────────────┬─────────────┐
│   ホーム     │ スタンプ一覧  │
├─────────────┼─────────────┤
│   マップ     │  ランキング   │
└─────────────┴─────────────┘
```

**各ボタンの設定:**

| ボタン名 | アクション | URL/アクション |
|---------|-----------|---------------|
| ホーム | URIアクション | `https://liff.line.me/{LIFF_ID}` |
| スタンプ一覧 | URIアクション | `https://liff.line.me/{LIFF_ID}/stamps.html` |
| マップ | URIアクション | `https://liff.line.me/{LIFF_ID}/map.html` （将来実装） |
| ランキング | URIアクション | `https://liff.line.me/{LIFF_ID}/ranking.html` （Phase 3で実装） |

**リッチメニューJSON設定例:**

```json
{
  "size": {
    "width": 2500,
    "height": 843
  },
  "selected": true,
  "name": "メインメニュー",
  "chatBarText": "メニュー",
  "areas": [
    {
      "bounds": {
        "x": 0,
        "y": 0,
        "width": 1250,
        "height": 421
      },
      "action": {
        "type": "uri",
        "uri": "https://liff.line.me/{LIFF_ID}"
      }
    },
    {
      "bounds": {
        "x": 1251,
        "y": 0,
        "width": 1249,
        "height": 421
      },
      "action": {
        "type": "uri",
        "uri": "https://liff.line.me/{LIFF_ID}/stamps.html"
      }
    },
    {
      "bounds": {
        "x": 0,
        "y": 422,
        "width": 1250,
        "height": 421
      },
      "action": {
        "type": "uri",
        "uri": "https://liff.line.me/{LIFF_ID}/map.html"
      }
    },
    {
      "bounds": {
        "x": 1251,
        "y": 422,
        "width": 1249,
        "height": 421
      },
      "action": {
        "type": "uri",
        "uri": "https://liff.line.me/{LIFF_ID}/ranking.html"
      }
    }
  ]
}
```

**注意事項:**
- LIFF IDは実際の値を設定してください
- 画像は2500x843ピクセルまたは2500x1686ピクセル（2段レイアウト）
- 画像は必須ではありませんが、あると見栄えが良くなります

#### 1.3 リッチメニューの公開

1. リッチメニューを作成後、「公開」ボタンをクリック
2. リッチメニューIDをメモ（例: `richmenu-xxxxxxxxxxxxx`）
3. デフォルトリッチメニューとして設定（任意）

---

### Step 2: Lambda関数のデプロイ

#### 2.1 パッケージの作成

```bash
cd backend/lambda/richmenu

# 依存ライブラリをインストール
pip install -r requirements.txt -t .

# ZIPファイルを作成（lambda_function.pyとresponse_utils.pyを含める）
zip -r lambda-richmenu.zip lambda_function.py response_utils.py requests/ urllib3/ ...

# または、既存のbuild.shを参考にする
```

#### 2.2 Lambda関数の作成

1. **AWS Lambda Consoleにアクセス**
   - https://console.aws.amazon.com/lambda/
   - 「関数の作成」をクリック

2. **関数の設定**
   - 関数名: `richmenu`
   - ランタイム: `Python 3.11`
   - アーキテクチャ: `x86_64`

3. **ZIPファイルをアップロード**
   - 「コードソース」セクション
   - 「.zipファイルをアップロード」を選択
   - `lambda-richmenu.zip`をアップロード

#### 2.3 環境変数の設定

1. Lambda関数の「設定」タブ → 「環境変数」
2. 「編集」をクリック
3. 以下の環境変数を追加:

| キー | 値 | 説明 |
|------|-----|------|
| `LINE_CHANNEL_ACCESS_TOKEN` | `YOUR_CHANNEL_ACCESS_TOKEN` | LINE Developers Consoleで取得したトークン |

**注意**: 将来的にSecrets Managerを使用する場合は、環境変数の値をSecrets Manager ARNに変更

#### 2.4 IAM権限の設定

Lambda関数の実行ロールに以下の権限を追加（必要に応じて）:

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "logs:CreateLogGroup",
        "logs:CreateLogStream",
        "logs:PutLogEvents"
      ],
      "Resource": "arn:aws:logs:*:*:*"
    }
  ]
}
```

---

### Step 3: API Gateway設定

#### 3.1 リソースの作成

1. **API Gateway Consoleにアクセス**
   - 既存のAPI Gateway（devステージ）を開く
   - または新規作成

2. **リソースの追加**
   - `/richmenu` リソースを作成

3. **サブリソースの追加**
   - `/richmenu/list` (GET)
   - `/richmenu/set` (POST)
   - `/richmenu/{richmenuId}` (GET)
   - `/richmenu/unset/{userId}` (DELETE)

#### 3.2 メソッドの設定

各メソッドで以下を設定:

1. **統合タイプ**: Lambda関数
2. **Lambda関数**: `richmenu`
3. **Lambda プロキシ統合**: 有効化

#### 3.3 CORS設定

各メソッドで以下を設定:

- **アクセス制御許可オリジン**: `*`（本番では特定ドメインを指定）
- **アクセス制御許可ヘッダー**: `Content-Type,Authorization`
- **アクセス制御許可メソッド**: `GET,POST,OPTIONS,DELETE`

#### 3.4 APIのデプロイ

1. 「アクション」→「APIのデプロイ」
2. デプロイステージ: `dev`
3. 「デプロイ」をクリック
4. エンドポイントURLをメモ

---

### Step 4: 動作確認

#### 4.1 リッチメニュー一覧取得の確認

```bash
curl -X GET \
  'https://{API_GATEWAY_URL}/dev/richmenu/list' \
  -H 'Content-Type: application/json'
```

**期待されるレスポンス:**
```json
{
  "statusCode": 200,
  "body": {
    "richmenus": [
      {
        "richMenuId": "richmenu-xxxxxxxxxxxxx",
        "size": {
          "width": 2500,
          "height": 843
        },
        "selected": true,
        "name": "メインメニュー",
        "chatBarText": "メニュー",
        "areas": [...]
      }
    ]
  }
}
```

#### 4.2 リッチメニュー設定の確認

```bash
curl -X POST \
  'https://{API_GATEWAY_URL}/dev/richmenu/set' \
  -H 'Content-Type: application/json' \
  -d '{
    "user_id": "USER_ID",
    "richmenu_id": "richmenu-xxxxxxxxxxxxx"
  }'
```

**期待されるレスポンス:**
```json
{
  "statusCode": 200,
  "body": {
    "ok": true,
    "user_id": "USER_ID",
    "richmenu_id": "richmenu-xxxxxxxxxxxxx",
    "message": "Rich menu set successfully"
  }
}
```

#### 4.3 LINEアプリでの確認

1. LINEアプリを開く
2. 公式アカウントまたはトークを開く
3. 画面下部にリッチメニューが表示されることを確認
4. 各ボタンをタップして、LIFFアプリが正しく遷移することを確認

---

## 🔧 トラブルシューティング

### エラー: `LINE_CHANNEL_ACCESS_TOKEN environment variable is not set`

**原因**: 環境変数が設定されていない

**解決方法**:
1. Lambda関数の環境変数を確認
2. 環境変数名が正確か確認（大文字小文字に注意）
3. 値を再設定

### エラー: `401 Unauthorized`

**原因**: チャンネルアクセストークンが無効

**解決方法**:
1. LINE Developers Consoleで新しいトークンを発行
2. Lambda関数の環境変数を更新
3. トークンの有効期限を確認

### エラー: `404 Not Found`（リッチメニューが見つからない）

**原因**: リッチメニューIDが間違っている、またはリッチメニューが公開されていない

**解決方法**:
1. LINE Developers ConsoleでリッチメニューIDを確認
2. リッチメニューが公開されているか確認
3. `/richmenu/list` APIで正しいIDを取得

### リッチメニューが表示されない

**原因**: 
- リッチメニューがデフォルトとして設定されていない
- ユーザーが友達登録していない

**解決方法**:
1. LINE Developers Consoleでリッチメニューを「デフォルト」に設定
2. ユーザーが公式アカウントを友達登録しているか確認
3. リッチメニューが公開されているか確認

---

## 📝 チェックリスト

- [ ] LINE Developers Consoleでリッチメニューを作成
- [ ] リッチメニューを公開
- [ ] Lambda関数を作成・デプロイ
- [ ] 環境変数（LINE_CHANNEL_ACCESS_TOKEN）を設定
- [ ] API Gatewayリソースを作成
- [ ] CORS設定を有効化
- [ ] APIをデプロイ
- [ ] 動作確認（curlテスト）
- [ ] LINEアプリで動作確認

---

## 🔗 参考リンク

- [LINE Messaging API - リッチメニュー](https://developers.line.biz/ja/docs/messaging-api/using-rich-menus/)
- [リッチメニューAPI リファレンス](https://developers.line.biz/ja/reference/messaging-api/#rich-menu)
- [リッチメニュー作成ツール](https://developers.line.biz/ja/services/rich-menu-designer/)

---

**最終更新**: 2025年11月

