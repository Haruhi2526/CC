# 本番環境移行手順

開発環境から本番環境への移行手順を説明します。

## 目次

1. [概要](#概要)
2. [前提条件](#前提条件)
3. [移行フロー](#移行フロー)
4. [手順1: 本番環境の準備](#手順1-本番環境の準備)
5. [手順2: セキュリティ設定の強化](#手順2-セキュリティ設定の強化)
6. [手順3: 本番環境へのデプロイ](#手順3-本番環境へのデプロイ)
7. [手順4: データ移行](#手順4-データ移行)
8. [手順5: カスタムドメイン設定（オプション）](#手順5-カスタムドメイン設定オプション)
9. [手順6: モニタリングとアラート設定](#手順6-モニタリングとアラート設定)
10. [手順7: 動作確認と切り替え](#手順7-動作確認と切り替え)
11. [手順8: ロールバック手順](#手順8-ロールバック手順)
12. [トラブルシューティング](#トラブルシューティング)

---

## 概要

本番環境への移行では、開発環境で動作確認が完了したアプリケーションを本番環境にデプロイし、実際のユーザーに提供できる状態にします。

### 本番環境と開発環境の違い

| 項目 | 開発環境 | 本番環境 |
|-----|---------|---------|
| **環境名** | `dev` | `prod` |
| **リソース命名** | `stamp-rally-*` | `stamp-rally-prod-*` |
| **CORS設定** | `*`（すべて許可） | 特定ドメインのみ |
| **シークレット管理** | 環境変数 | AWS Secrets Manager |
| **IAM権限** | 広範囲 | 最小権限 |
| **モニタリング** | 基本ログ | 詳細アラート |
| **バックアップ** | オプション | 必須 |

---

## 前提条件

### 必要なもの

- 開発環境で動作確認が完了していること
- 本番用AWSアカウントまたはリージョンへのアクセス権限
- 本番用LINE Developersチャネルの設定
- 本番用ドメイン（カスタムドメインを使用する場合）

### 確認事項

- [ ] 開発環境で全機能が正常に動作している
- [ ] セキュリティテストが完了している
- [ ] パフォーマンステストが完了している
- [ ] 本番環境のリソース命名規則が決定している
- [ ] 本番環境のリージョンが決定している

---

## 移行フロー

```
1. 本番環境の準備
   ├─ AWSアカウント/リージョンの確認
   ├─ 命名規則の決定
   └─ リソース計画の作成
   ↓
2. セキュリティ設定の強化
   ├─ Secrets Managerの設定
   ├─ IAM最小権限の設定
   └─ 暗号化の有効化
   ↓
3. 本番環境へのデプロイ
   ├─ DynamoDBテーブルの作成
   ├─ Lambda関数のデプロイ
   └─ API Gatewayの設定
   ↓
4. データ移行（必要に応じて）
   ├─ スタンプマスターデータの移行
   └─ ユーザーデータの移行（オプション）
   ↓
5. カスタムドメイン設定（オプション）
   ↓
6. モニタリングとアラート設定
   ↓
7. 動作確認と切り替え
   ├─ 本番環境の動作確認
   ├─ フロントエンドの設定変更
   └─ LINE Developersの設定変更
   ↓
8. 本番稼働開始
```

**推定所要時間**: 初回移行で約3〜4時間

---

## 手順1: 本番環境の準備

### 1-1. AWSアカウントとリージョンの確認

#### アカウント戦略

**オプションA: 同じAWSアカウント、別リージョン**
- メリット: 管理が簡単、コスト削減
- デメリット: 環境分離が弱い

**オプションB: 別AWSアカウント**
- メリット: 完全な環境分離、セキュリティ向上
- デメリット: 管理が複雑、コスト増

**推奨**: 小規模プロジェクトはオプションA、大規模プロジェクトはオプションB

#### リージョン選択

- **推奨リージョン**: `ap-northeast-1`（東京）
  - 日本国内のユーザーが多い場合
  - レイテンシが低い
- **代替リージョン**: `us-east-1`（バージニア）
  - グローバル展開を検討している場合
  - 一部サービスで利用可能な機能が多い

### 1-2. 命名規則の決定

本番環境のリソースには`-prod`サフィックスを付けることを推奨します。

| リソースタイプ | 開発環境 | 本番環境 |
|--------------|---------|---------|
| **Lambda関数** | `stamp-rally-auth` | `stamp-rally-prod-auth` |
| **DynamoDBテーブル** | `Users` | `Users-prod`（または`Users`） |
| **API Gateway** | `stamp-rally-api` | `stamp-rally-prod-api` |
| **IAMロール** | `stamp-rally-auth-role` | `stamp-rally-prod-auth-role` |
| **ステージ名** | `dev` | `prod` |

> **注意**: DynamoDBテーブル名は環境変数で管理するため、同じ名前でも問題ありません。

### 1-3. リソース計画の作成

本番環境で作成するリソースの一覧を作成します。

**DynamoDBテーブル**:
- `Users-prod`（または`Users`）
- `UserStamps-prod`（または`UserStamps`）
- `StampMasters-prod`（または`StampMasters`）

**Lambda関数**:
- `stamp-rally-prod-auth`
- `stamp-rally-prod-award`
- `stamp-rally-prod-gps-verify`
- `stamp-rally-prod-notify`
- `stamp-rally-prod-ranking`
- `stamp-rally-prod-richmenu`
- `stamp-rally-prod-stamps`

**API Gateway**:
- `stamp-rally-prod-api`
- ステージ: `prod`

---

## 手順2: セキュリティ設定の強化

### 2-1. AWS Secrets Managerの設定

本番環境では、機密情報を環境変数ではなくAWS Secrets Managerで管理します。

#### Secrets Managerに保存する情報

- `TOKEN_SECRET_KEY`: セッショントークン署名用キー
- `LINE_CHANNEL_ACCESS_TOKEN`: LINE Messaging APIアクセストークン

#### シークレットの作成手順

1. **Secrets Managerコンソールを開く**
   - AWS Consoleで「Secrets Manager」を検索
   - 「シークレットを保存」をクリック

2. **シークレットタイプの選択**
   - 「その他のシークレットタイプ」を選択

3. **シークレット値の入力**

   **TOKEN_SECRET_KEYの場合**:
   ```json
   {
     "TOKEN_SECRET_KEY": "your-production-secret-key-here"
   }
   ```
   
   > **重要**: 本番用のシークレットキーは強力なランダムな文字列を使用してください。  
   > 生成方法: `openssl rand -hex 64`

   **LINE_CHANNEL_ACCESS_TOKENの場合**:
   ```json
   {
     "LINE_CHANNEL_ACCESS_TOKEN": "your-line-channel-access-token"
   }
   ```

4. **シークレット名の設定**
   - `stamp-rally-prod/token-secret-key`
   - `stamp-rally-prod/line-channel-access-token`

5. **暗号化キーの選択**
   - デフォルトのAWS管理キーを使用（またはカスタムKMSキー）

6. **「次へ」→「保存」をクリック**

#### Lambda関数でのSecrets Manager参照

Lambda関数のコードを修正して、Secrets Managerからシークレットを取得するようにします。

**例: token_utils.pyの修正**

```python
import boto3
import json
import os

secrets_client = boto3.client('secretsmanager')

def get_secret_key() -> str:
    """
    Secrets Managerからシークレットキーを取得
    """
    secret_name = os.environ.get('SECRET_NAME_TOKEN_KEY', 'stamp-rally-prod/token-secret-key')
    
    try:
        response = secrets_client.get_secret_value(SecretId=secret_name)
        secret = json.loads(response['SecretString'])
        return secret['TOKEN_SECRET_KEY']
    except Exception as e:
        # フォールバック: 環境変数から取得（開発環境用）
        return os.environ.get('TOKEN_SECRET_KEY', 'default-secret-key-change-in-production')
```

#### IAMロールへの権限追加

Lambda関数のIAMロールにSecrets Managerへのアクセス権限を追加します。

**JSONポリシー例**:

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "secretsmanager:GetSecretValue"
      ],
      "Resource": [
        "arn:aws:secretsmanager:*:*:secret:stamp-rally-prod/*"
      ]
    }
  ]
}
```

### 2-2. IAM最小権限の設定

本番環境では、各Lambda関数に最小限の権限のみを付与します。

#### 推奨IAMポリシー

**auth関数**:
- DynamoDB: `Users`テーブルのみ（GetItem, PutItem, UpdateItem, Query）
- Secrets Manager: `stamp-rally-prod/token-secret-key`の読み取り

**award関数**:
- DynamoDB: `UserStamps`, `StampMasters`テーブル（GetItem, PutItem, Query）
- Secrets Manager: 不要
- Lambda: `stamp-rally-prod-notify`の呼び出し（オプション）

**gps-verify関数**:
- DynamoDB: `StampMasters`テーブルのみ（GetItem, Query）

**notify関数**:
- Secrets Manager: `stamp-rally-prod/line-channel-access-token`の読み取り

**richmenu関数**:
- Secrets Manager: `stamp-rally-prod/line-channel-access-token`の読み取り

### 2-3. 暗号化の有効化

#### DynamoDBの暗号化

1. DynamoDBコンソールでテーブルを選択
2. 「概要」タブ → 「暗号化」セクション
3. 「編集」をクリック
4. **暗号化タイプ**: 「AWS所有キー」または「AWS管理キー」を選択
5. 「変更を保存」をクリック

#### S3の暗号化（画像保存を使用する場合）

1. S3バケットの設定
2. 「デフォルトの暗号化」を有効化
3. **暗号化タイプ**: 「AWS-KMS」を選択

### 2-4. API Gatewayのセキュリティ設定

#### レート制限の設定

1. API GatewayコンソールでAPIを選択
2. 「使用量プラン」→「使用量プランの作成」
3. 設定:
   - **名前**: `stamp-rally-prod-usage-plan`
   - **スロットリング**: 
     - **レート**: `1000`（1秒あたりのリクエスト数）
     - **バースト**: `2000`（同時リクエスト数）
   - **クォータ**: 
     - **リクエスト数**: `100000`（1日あたり）

#### APIキーの設定（オプション）

1. 「APIキー」→「APIキーの作成」
2. 名前を入力: `stamp-rally-prod-api-key`
3. 使用量プランにAPIキーを関連付け

---

## 手順3: 本番環境へのデプロイ

### 3-1. DynamoDBテーブルの作成

本番環境用のDynamoDBテーブルを作成します。

📖 **詳細手順**: [AWS-Console-DynamoDB設定手順.md](./AWS-Console-DynamoDB設定手順.md)

**本番環境での設定**:
- テーブル名: `Users-prod`, `UserStamps-prod`, `StampMasters-prod`（または環境変数で管理）
- キャパシティモード: **オンデマンド**（推奨）または**プロビジョンド**（予測可能な負荷の場合）
- ポイントインタイムリカバリ (PITR): **有効化**（必須）
- タグ: `Environment: prod`, `Project: CC`

### 3-2. Lambda関数のデプロイ

本番環境用のLambda関数をデプロイします。

📖 **基本手順**: [AWS-Console-Deploy手順.md](./AWS-Console-Deploy手順.md)

**本番環境での設定**:

#### 関数名の変更

- 開発環境: `stamp-rally-auth`
- 本番環境: `stamp-rally-prod-auth`

#### 環境変数の設定

| キー | 値 | 説明 |
|-----|-----|------|
| `TABLE_USERS` | `Users-prod` | 本番環境のテーブル名 |
| `TABLE_USERSTAMPS` | `UserStamps-prod` | 本番環境のテーブル名 |
| `TABLE_STAMPMASTERS` | `StampMasters-prod` | 本番環境のテーブル名 |
| `SECRET_NAME_TOKEN_KEY` | `stamp-rally-prod/token-secret-key` | Secrets Managerのシークレット名 |
| `SECRET_NAME_LINE_TOKEN` | `stamp-rally-prod/line-channel-access-token` | Secrets Managerのシークレット名 |
| `ENVIRONMENT` | `prod` | 環境識別子 |

> **注意**: `TOKEN_SECRET_KEY`と`LINE_CHANNEL_ACCESS_TOKEN`は環境変数から削除し、Secrets Managerから取得するように変更してください。

#### IAMロールの設定

- 最小権限の原則に従って設定
- Secrets Managerへのアクセス権限を追加
- 本番環境のリソースのみにアクセス可能にする

#### タイムアウトとメモリ

- **タイムアウト**: `30秒`（開発環境と同じ）
- **メモリ**: `256 MB`（開発環境と同じ、必要に応じて調整）

### 3-3. API Gatewayの設定

本番環境用のAPI Gatewayを設定します。

#### REST APIの作成

1. API Gatewayコンソールで「APIを作成」
2. **API名**: `stamp-rally-prod-api`
3. 開発環境と同じリソースとメソッドを作成

#### CORS設定

**重要**: 本番環境では、CORSの`Access-Control-Allow-Origin`を特定のドメインに制限します。

- **開発環境**: `*`（すべて許可）
- **本番環境**: `https://liff.line.me`（LINE LIFFのドメイン）またはカスタムドメイン

**設定例**:
- **Access-Control-Allow-Origin**: `https://liff.line.me`
- **Access-Control-Allow-Headers**: `Content-Type,Authorization`
- **Access-Control-Allow-Methods**: `GET,POST,OPTIONS,DELETE`

#### APIのデプロイ

1. 「アクション」→「APIのデプロイ」
2. **デプロイされるステージ**: 「新しいステージ」を選択
3. **ステージ名**: `prod`
4. **ステージの説明**: 本番環境
5. 「デプロイ」をクリック

#### 呼び出しURLの確認

本番環境のAPIエンドポイントURLをメモします。

例: `https://xxxxxxxxxx.execute-api.ap-northeast-1.amazonaws.com/prod`

---

## 手順4: データ移行

### 4-1. スタンプマスターデータの移行

開発環境の`StampMasters`テーブルから本番環境の`StampMasters-prod`テーブルにデータを移行します。

#### データエクスポート（開発環境）

```bash
# AWS CLIを使用してデータをエクスポート
aws dynamodb scan \
  --table-name StampMasters \
  --region us-east-1 \
  --output json > stamp-masters-dev.json
```

#### データインポート（本番環境）

📖 **詳細手順**: [DynamoDB-スタンプマスターデータ投入手順.md](./DynamoDB-スタンプマスターデータ投入手順.md)

または、AWS CLIを使用:

```bash
# データをインポート
aws dynamodb batch-write-item \
  --request-items file://stamp-masters-prod.json \
  --region ap-northeast-1
```

### 4-2. ユーザーデータの移行（オプション）

開発環境のユーザーデータを本番環境に移行する場合:

> **注意**: 通常、本番環境は新規ユーザーから開始するため、ユーザーデータの移行は不要です。  
> 移行が必要な場合は、個人情報保護法などの法規制に注意してください。

---

## 手順5: カスタムドメイン設定（オプション）

カスタムドメインを使用する場合の設定手順です。

### 5-1. カスタムドメインの作成

1. API Gatewayコンソールで「カスタムドメイン名」を選択
2. 「カスタムドメイン名を作成」をクリック
3. **ドメイン名**: `api.yourdomain.com`（例）
4. **エンドポイントタイプ**: リージョン
5. **セキュリティポリシー**: TLS 1.2
6. 「ドメイン名を作成」をクリック

### 5-2. SSL証明書の設定

1. AWS Certificate Manager (ACM)で証明書をリクエスト
2. ドメインの所有権を確認
3. 証明書をカスタムドメインにアタッチ

### 5-3. ルーティング設定

1. カスタムドメインの「APIマッピング」タブ
2. 「APIマッピングを作成」をクリック
3. **API**: `stamp-rally-prod-api`を選択
4. **ステージ**: `prod`を選択
5. **パス**: （空欄、または`/v1`など）

### 5-4. DNS設定

1. カスタムドメインの「APIマッピング」タブで**ターゲットドメイン名**を確認
2. DNSプロバイダーでCNAMEレコードを追加:
   - **名前**: `api`（またはサブドメイン名）
   - **値**: ターゲットドメイン名

---

## 手順6: モニタリングとアラート設定

### 6-1. CloudWatchアラームの設定

#### Lambda関数のエラー率アラーム

1. CloudWatchコンソールで「アラーム」→「アラームの作成」
2. **メトリクス**: Lambda → 関数名 → エラー
3. **条件**: 
   - **しきい値**: `5`（5分間で5回以上のエラー）
   - **期間**: `5分`
4. **通知**: SNSトピックを作成して通知先を設定

#### API Gatewayの4xx/5xxエラーアラーム

1. **メトリクス**: API Gateway → API名 → 4XXError / 5XXError
2. **条件**: 
   - **しきい値**: `10`（5分間で10回以上のエラー）
   - **期間**: `5分`

#### DynamoDBのスロットリングアラーム

1. **メトリクス**: DynamoDB → テーブル名 → UserErrors
2. **条件**: 
   - **しきい値**: `1`（1回でもスロットリングが発生）

### 6-2. CloudWatchダッシュボードの作成

1. CloudWatchコンソールで「ダッシュボード」→「ダッシュボードの作成」
2. ダッシュボード名: `stamp-rally-prod-dashboard`
3. 以下のウィジェットを追加:
   - Lambda関数の実行回数
   - Lambda関数のエラー率
   - API Gatewayのリクエスト数
   - API Gatewayのレイテンシ
   - DynamoDBの読み書きユニット

### 6-3. ログ保持期間の設定

1. CloudWatch Logsでロググループを選択
2. 「ログの保持」を設定:
   - **保持期間**: `30日`（本番環境では長めに設定）

---

## 手順7: 動作確認と切り替え

### 7-1. 本番環境の動作確認

#### APIエンドポイントのテスト

```bash
# 認証エンドポイントのテスト
curl -X POST https://{api-id}.execute-api.{region}.amazonaws.com/prod/auth/verify \
  -H "Content-Type: application/json" \
  -d '{"id_token": "test_token"}'

# スタンプ一覧取得のテスト
curl -X GET "https://{api-id}.execute-api.{region}.amazonaws.com/prod/stamps?userId=test_user" \
  -H "Content-Type: application/json"
```

#### 動作確認チェックリスト

- [ ] すべてのAPIエンドポイントが正常に動作する
- [ ] CORS設定が正しく機能する
- [ ] Secrets Managerからシークレットが正しく取得できる
- [ ] DynamoDBへの読み書きが正常に動作する
- [ ] エラーハンドリングが正しく動作する
- [ ] CloudWatch Logsにログが出力される

### 7-2. フロントエンドの設定変更

本番環境のAPIエンドポイントに切り替えます。

#### config.jsの更新

`frontend/liff-app/js/config.js`を更新:

```javascript
const CONFIG = {
    // 本番環境のAPIエンドポイント
    API_BASE_URL: 'https://{api-id}.execute-api.{region}.amazonaws.com/prod',
    
    // 本番環境のLIFF ID
    LIFF_ID: window.LIFF_ID || '{本番環境のLIFF ID}',
    
    // ... その他の設定
};
```

#### フロントエンドのデプロイ

1. 変更をコミット・プッシュ
2. 静的ホスティング（S3 + CloudFrontなど）にデプロイ
3. または、LINE LIFFアプリとしてデプロイ

### 7-3. LINE Developersの設定変更

#### 本番環境のLIFFアプリ設定

1. LINE Developers Consoleで本番環境のチャネルを選択
2. 「LIFF」タブを開く
3. LIFFアプリの設定:
   - **エンドポイントURL**: 本番環境のフロントエンドURL
   - **スコープ**: `profile`, `openid`
   - **ボット機能**: 必要に応じて有効化

#### 本番環境のMessaging API設定

1. 「Messaging API」タブを開く
2. **Channel access token**: 本番環境用のトークンを発行
3. Secrets Managerに保存（手順2-1を参照）

### 7-4. 切り替え手順

1. **メンテナンスモードの有効化**（オプション）
   - 開発環境でメンテナンスモードを有効化
   - ユーザーに通知

2. **本番環境の最終確認**
   - すべての機能が正常に動作することを確認
   - パフォーマンステストを実行

3. **フロントエンドの切り替え**
   - 本番環境のAPIエンドポイントに切り替え
   - 動作確認

4. **LINE Developersの切り替え**
   - 本番環境のLIFFアプリURLに切り替え
   - 動作確認

5. **本番稼働開始**
   - メンテナンスモードを解除
   - モニタリングを開始

---

## 手順8: ロールバック手順

問題が発生した場合のロールバック手順です。

### 8-1. フロントエンドのロールバック

1. `config.js`を開発環境の設定に戻す
2. フロントエンドを再デプロイ

### 8-2. API Gatewayのロールバック

1. API GatewayコンソールでAPIを選択
2. 「デプロイ履歴」を確認
3. 以前のデプロイに戻す

### 8-3. Lambda関数のロールバック

1. Lambda関数の「バージョン」タブ
2. 以前のバージョンを選択
3. エイリアスを以前のバージョンに変更

### 8-4. DynamoDBのロールバック

1. ポイントインタイムリカバリ (PITR) を使用
2. 問題発生時点より前の時点に復元

---

## トラブルシューティング

### よくある問題と対処法

#### 問題1: Secrets Managerからシークレットが取得できない

**症状**: `AccessDeniedException`エラー

**対処**:
1. IAMロールにSecrets Managerへのアクセス権限があるか確認
2. シークレット名が正しいか確認
3. リージョンが正しいか確認

#### 問題2: CORSエラーが発生する

**症状**: ブラウザコンソールにCORSエラー

**対処**:
1. API GatewayのCORS設定を確認
2. `Access-Control-Allow-Origin`が正しいドメインに設定されているか確認
3. APIを再デプロイ

#### 問題3: 本番環境のパフォーマンスが悪い

**症状**: レスポンスタイムが長い

**対処**:
1. CloudWatchメトリクスでボトルネックを特定
2. Lambda関数のメモリを増やす
3. DynamoDBのキャパシティを調整
4. API Gatewayのキャッシュを有効化

---

## 本番環境移行チェックリスト

### 事前準備
- [ ] 開発環境で全機能が正常に動作している
- [ ] セキュリティテストが完了している
- [ ] パフォーマンステストが完了している
- [ ] 本番環境のリソース命名規則が決定している
- [ ] 本番環境のリージョンが決定している

### セキュリティ設定
- [ ] Secrets Managerにシークレットが保存されている
- [ ] IAMロールに最小権限が設定されている
- [ ] DynamoDBの暗号化が有効化されている
- [ ] API Gatewayのレート制限が設定されている

### デプロイ
- [ ] DynamoDBテーブルが作成されている
- [ ] すべてのLambda関数がデプロイされている
- [ ] API Gatewayが設定されている
- [ ] CORS設定が本番環境用に変更されている

### データ移行
- [ ] スタンプマスターデータが移行されている
- [ ] データの整合性が確認されている

### モニタリング
- [ ] CloudWatchアラームが設定されている
- [ ] CloudWatchダッシュボードが作成されている
- [ ] ログ保持期間が設定されている

### 動作確認
- [ ] すべてのAPIエンドポイントが正常に動作する
- [ ] フロントエンドが本番環境のAPIに接続できる
- [ ] LINE LIFFアプリが正常に動作する

### 切り替え
- [ ] フロントエンドの設定が更新されている
- [ ] LINE Developersの設定が更新されている
- [ ] 本番稼働が開始されている

---

## 参考ドキュメント

- [AWS-Console-Deploy手順.md](./AWS-Console-Deploy手順.md)
- [AWS-Console-DynamoDB設定手順.md](./AWS-Console-DynamoDB設定手順.md)
- [環境変数設定ガイド.md](./環境変数設定ガイド.md)
- [06-セキュリティ対策.md](./06-セキュリティ対策.md)
- [08-運用監視.md](./08-運用監視.md)

---

**最終更新**: 2025年1月  
**作成者**: 開発チーム

