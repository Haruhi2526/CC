# ランキング機能実装手順

**作成日**: 2025年1月  
**対象機能**: ランキング表示、週間/月間ランキング、友達比較、シェア機能

---

## 📋 実装完了項目

### ✅ バックエンド実装

#### 実装ファイル
- `backend/lambda/ranking/lambda_function.py` - ランキング管理API
- `backend/lambda/ranking/response_utils.py` - レスポンスユーティリティ
- `backend/lambda/ranking/requirements.txt` - 依存ライブラリ
- `backend/lambda/ranking/build.sh` - ビルドスクリプト

#### 機能
- ランキング計算（`POST /ranking/calculate`）
- 友達週間ランキング取得（`GET /ranking/friends/weekly`）- 自分自身も含む
- 友達月間ランキング取得（`GET /ranking/friends/monthly`）- 自分自身も含む
- 友達比較（`GET /ranking/compare`）

---

### ✅ フロントエンド実装

#### 実装ファイル
- `frontend/liff-app/ranking.html` - ランキング表示画面
- `frontend/liff-app/js/ranking.js` - ランキング画面ロジック
- `frontend/liff-app/js/api.js` - ランキングAPI呼び出し関数追加
- `frontend/liff-app/css/style.css` - ランキング画面スタイル追加

#### 機能
- 週間/月間ランキングの切り替え（友達ランキング）
- ランキング一覧表示（トップ3にメダル表示、自分自身は強調表示）
- 友達を招待する機能（招待URLをクリップボードにコピー）
- シェア機能（LINEシェアまたはURLコピー）
- エラーハンドリング

---

## 🚀 デプロイ手順

### 1. DynamoDBテーブル作成

#### Rankingsテーブル
1. AWS DynamoDBコンソールにアクセス
2. 「テーブルの作成」をクリック
3. テーブル設定:
   - **テーブル名**: `Rankings`
   - **パーティションキー**: `Period` (String)
   - **ソートキー**: `Rank` (Number)
4. 「テーブルの作成」をクリック

#### テーブル構造
```
Period (PK): "weekly-2025-W45" または "monthly-2025-11"
Rank (SK): 1, 2, 3, ...
UserId: "U1234567890..."
StampCount: 10
DisplayName: "ユーザー名"
UpdatedAt: 1234567890
```

---

### 2. Lambda関数のデプロイ

#### Step 1: ZIPファイルの作成
```bash
cd backend/lambda/ranking
./build.sh
```

#### Step 2: AWS Lambda関数の作成
1. AWS Lambdaコンソールにアクセス
2. 「関数の作成」をクリック
3. 関数名: `ranking`
4. ランタイム: Python 3.11
5. アーキテクチャ: x86_64
6. ZIPファイルをアップロード

#### Step 3: 環境変数の設定
- `TABLE_RANKINGS`: `Rankings`（デフォルト値）
- `TABLE_USERSTAMPS`: `UserStamps`（デフォルト値）
- `TABLE_USERS`: `Users`（デフォルト値）

#### Step 4: IAMロールの設定
以下の権限を追加:
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "dynamodb:Query",
        "dynamodb:Scan",
        "dynamodb:GetItem",
        "dynamodb:PutItem",
        "dynamodb:DeleteItem"
      ],
      "Resource": [
        "arn:aws:dynamodb:*:*:table/Rankings",
        "arn:aws:dynamodb:*:*:table/UserStamps",
        "arn:aws:dynamodb:*:*:table/Users"
      ]
    }
  ]
}
```

#### Step 5: API Gateway統合
1. API Gatewayコンソールで既存のAPIを選択
2. リソース `/ranking` を作成
3. 以下のメソッドを追加:
   - `POST /ranking/calculate` - ランキング計算
   - `GET /ranking/compare` - 友達比較（オプション）
   - `GET /ranking/friends/weekly` - 友達週間ランキング取得
   - `GET /ranking/friends/monthly` - 友達月間ランキング取得
4. 各メソッドにLambda統合を設定（プロキシ統合）
5. CORS設定を有効化

**注意**: `/ranking/weekly` と `/ranking/monthly` は実装されていません。友達ランキングのみを使用してください。

---

### 3. ランキング計算の自動実行（オプション）

#### EventBridgeルールの設定
1. Amazon EventBridgeコンソールにアクセス
2. 「ルール」→「ルールの作成」
3. ルール設定:
   - **名前**: `ranking-calculation-daily`
   - **スケジュール**: 毎日午前1時（UTC）
   - **ターゲット**: Lambda関数 `ranking`
   - **入力**: 定数JSON
     ```json
     {
       "httpMethod": "POST",
       "path": "/ranking/calculate",
       "queryStringParameters": {
         "type": "weekly"
       }
     }
     ```

---

## 📝 API仕様

**ベースURL**: `https://2bm71jvfs6.execute-api.us-east-1.amazonaws.com/dev`

### ランキング関連エンドポイント

#### POST /ranking/calculate
ランキングを計算してDynamoDBに保存

**メソッド**: `POST`  
**Lambda関数**: `ranking`  
**クエリパラメータ:**
- `type`: `weekly` または `monthly`（デフォルト: `weekly`）

**リクエスト例:**
```bash
curl -X POST "https://2bm71jvfs6.execute-api.us-east-1.amazonaws.com/dev/ranking/calculate?type=weekly"
```

**レスポンス例:**
```json
{
  "ok": true,
  "period": "2025-W45",
  "period_type": "weekly",
  "rankings_count": 10
}
```

**注意**: 週間ランキングは今週の月曜日0時00分00秒から、月間ランキングは今月の1日0時00分00秒からのスタンプをカウントします。

---

#### GET /ranking/friends/weekly
友達の週間ランキングを取得（自分自身も含む）

**メソッド**: `GET`  
**Lambda関数**: `ranking`  
**クエリパラメータ:**
- `user_id`: ユーザーID（必須）
- `period`: 期間文字列（例: `2025-W46`、省略時は現在の週）

**リクエスト例:**
```bash
curl -X GET "https://2bm71jvfs6.execute-api.us-east-1.amazonaws.com/dev/ranking/friends/weekly?user_id=U1234567890"
```

**レスポンス例:**
```json
{
  "ok": true,
  "period": "2025-W46",
  "period_type": "weekly",
  "rankings": [
    {
      "rank": 1,
      "user_id": "U1234567890...",
      "stamp_count": 15,
      "display_name": "ユーザー1",
      "is_self": true
    },
    {
      "rank": 2,
      "user_id": "U0987654321...",
      "stamp_count": 12,
      "display_name": "友達1",
      "is_self": false
    }
  ]
}
```

**注意**: 
- 友達リストに登録されている友達と自分自身がランキングに含まれます
- `is_self`フラグで自分自身かどうかを判別できます

---

#### GET /ranking/friends/monthly
友達の月間ランキングを取得（自分自身も含む）

**メソッド**: `GET`  
**Lambda関数**: `ranking`  
**クエリパラメータ:**
- `user_id`: ユーザーID（必須）
- `period`: 期間文字列（例: `2025-11`、省略時は現在の月）

**リクエスト例:**
```bash
curl -X GET "https://2bm71jvfs6.execute-api.us-east-1.amazonaws.com/dev/ranking/friends/monthly?user_id=U1234567890"
```

**レスポンス例:**
```json
{
  "ok": true,
  "period": "2025-11",
  "period_type": "monthly",
  "rankings": [
    {
      "rank": 1,
      "user_id": "U1234567890...",
      "stamp_count": 50,
      "display_name": "ユーザー1",
      "is_self": true
    },
    {
      "rank": 2,
      "user_id": "U0987654321...",
      "stamp_count": 45,
      "display_name": "友達1",
      "is_self": false
    }
  ]
}
```

**注意**: 
- 友達リストに登録されている友達と自分自身がランキングに含まれます
- `is_self`フラグで自分自身かどうかを判別できます

---

#### GET /ranking/compare
2人のユーザーを比較

**メソッド**: `GET`  
**Lambda関数**: `ranking`  
**クエリパラメータ:**
- `user_id`: ユーザーID（必須）
- `friend_id`: 友達のユーザーID（必須）

**リクエスト例:**
```bash
curl -X GET "https://2bm71jvfs6.execute-api.us-east-1.amazonaws.com/dev/ranking/compare?user_id=U1234567890&friend_id=U0987654321"
```

**レスポンス例:**
```json
{
  "ok": true,
  "user": {
    "user_id": "U1234567890...",
    "display_name": "ユーザー1",
    "stamp_count": 15
  },
  "friend": {
    "user_id": "U0987654321...",
    "display_name": "ユーザー2",
    "stamp_count": 12
  },
  "rank_diff": 3,
  "user_is_higher": true
}
```

---

### 友達関連エンドポイント

#### POST /friends/add
友達関係を追加（双方向）

**メソッド**: `POST`  
**Lambda関数**: `friends`  
**リクエストボディ:**
```json
{
  "user_id": "U1234567890...",
  "friend_id": "U0987654321..."
}
```

**リクエスト例:**
```bash
curl -X POST "https://2bm71jvfs6.execute-api.us-east-1.amazonaws.com/dev/friends/add" \
  -H "Content-Type: application/json" \
  -d '{
    "user_id": "U1234567890",
    "friend_id": "U0987654321"
  }'
```

**レスポンス例:**
```json
{
  "ok": true,
  "message": "Friend relationship added successfully"
}
```

---

#### GET /friends/list
友達リストを取得

**メソッド**: `GET`  
**Lambda関数**: `friends`  
**クエリパラメータ:**
- `user_id`: ユーザーID（必須）

**リクエスト例:**
```bash
curl -X GET "https://2bm71jvfs6.execute-api.us-east-1.amazonaws.com/dev/friends/list?user_id=U1234567890"
```

**レスポンス例:**
```json
{
  "ok": true,
  "friends": [
    "U0987654321...",
    "U1111111111..."
  ],
  "count": 2
}
```

---

## 👥 友達追加機能

### 実装概要

ランキング機能では、友達リストに登録されている友達と自分自身のランキングを表示します。友達を追加するには、招待リンクを使用します。

### フロントエンド実装

#### 友達を招待する機能

ランキング画面の「友達を招待」ボタンから、招待URLをクリップボードにコピーできます。

```javascript
// 招待リンクの形式
const inviteUrl = `${window.location.origin}/index.html?invite=${userId}`;
```

#### 招待リンクの処理

アプリを開いたときに、URLパラメータから招待元を取得し、自動的に友達関係を追加します。

```javascript
// index.htmlで招待リンクを処理
const urlParams = new URLSearchParams(window.location.search);
const inviteUserId = urlParams.get('invite');

if (inviteUserId) {
    // 認証後に友達関係を追加
    await api.addFriend(userId, inviteUserId);
}
```

### バックエンド実装

#### Friendsテーブル

```
パーティションキー: UserId (String)
ソートキー: FriendId (String)
属性:
  - CreatedAt: Number (タイムスタンプ)
  - Status: String ('active', 'blocked')
```

#### friends Lambda関数

- `POST /friends/add` - 友達関係を追加（双方向）
- `GET /friends/list` - 友達リストを取得

**注意**: 友達関係は双方向で保存されます（`user_id -> friend_id` と `friend_id -> user_id` の両方）。

---

## 🧪 テスト方法

### ランキング計算のテスト
```bash
curl -X POST "https://2bm71jvfs6.execute-api.us-east-1.amazonaws.com/dev/ranking/calculate?type=weekly"
```

### 友達週間ランキング取得のテスト
```bash
curl -X GET "https://2bm71jvfs6.execute-api.us-east-1.amazonaws.com/dev/ranking/friends/weekly?user_id=USER_ID"
```

### 友達月間ランキング取得のテスト
```bash
curl -X GET "https://2bm71jvfs6.execute-api.us-east-1.amazonaws.com/dev/ranking/friends/monthly?user_id=USER_ID"
```

### 友達比較のテスト
```bash
curl -X GET "https://2bm71jvfs6.execute-api.us-east-1.amazonaws.com/dev/ranking/compare?user_id=USER_ID&friend_id=FRIEND_ID"
```

### 友達追加のテスト
```bash
curl -X POST "https://2bm71jvfs6.execute-api.us-east-1.amazonaws.com/dev/friends/add" \
  -H "Content-Type: application/json" \
  -d '{"user_id": "USER_ID", "friend_id": "FRIEND_ID"}'
```

### 友達リスト取得のテスト
```bash
curl -X GET "https://2bm71jvfs6.execute-api.us-east-1.amazonaws.com/dev/friends/list?user_id=USER_ID"
```

---

## ⚠️ 注意事項

### パフォーマンス
- ランキング計算は`UserStamps`テーブルをスキャンするため、ユーザー数が多い場合は時間がかかる可能性があります
- 実際の運用では、日次バッチ処理でランキングを事前計算することを推奨します

### データ整合性
- ランキング計算は期間内のスタンプのみをカウントします
- 週間ランキング: 現在の週の月曜日0時00分00秒から現在時刻まで
- 月間ランキング: 現在の月の1日0時00分00秒から現在時刻まで
- 友達ランキングには、Friendsテーブルに登録されている友達と自分自身が含まれます

### コスト管理
- DynamoDBのスキャン操作は読み取り容量ユニットを消費します
- ランキング計算は定期的に実行することを推奨します（日次など）

---

## 📚 参考資料

- [ランキングAPI Gateway完全設定手順](./ランキングAPI Gateway完全設定手順.md) - API Gatewayの詳細な設定手順
- [ランキング表示されない問題の解決方法](./ランキング表示されない問題の解決方法.md) - トラブルシューティング
- [ランキング機能使い方ガイド](./ランキング機能使い方ガイド.md) - ユーザー向け使い方ガイド
- [DynamoDB ドキュメント](https://docs.aws.amazon.com/ja_jp/amazondynamodb/)
- [EventBridge スケジュールルール](https://docs.aws.amazon.com/ja_jp/eventbridge/latest/userguide/eb-create-rule-schedule.html)

---

**最終更新**: 2025年1月

