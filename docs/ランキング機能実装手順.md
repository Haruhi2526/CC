# ãƒ©ãƒ³ã‚­ãƒ³ã‚°æ©Ÿèƒ½å®Ÿè£…æ‰‹é †

**ä½œæˆæ—¥**: 2025å¹´1æœˆ  
**å¯¾è±¡æ©Ÿèƒ½**: ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤ºã€é€±é–“/æœˆé–“ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã€å‹é”æ¯”è¼ƒã€ã‚·ã‚§ã‚¢æ©Ÿèƒ½

---

## ğŸ“‹ å®Ÿè£…å®Œäº†é …ç›®

### âœ… ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å®Ÿè£…

#### å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«
- `backend/lambda/ranking/lambda_function.py` - ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç®¡ç†API
- `backend/lambda/ranking/response_utils.py` - ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
- `backend/lambda/ranking/requirements.txt` - ä¾å­˜ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
- `backend/lambda/ranking/build.sh` - ãƒ“ãƒ«ãƒ‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

#### æ©Ÿèƒ½
- ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¨ˆç®—ï¼ˆ`POST /ranking/calculate`ï¼‰
- å‹é”é€±é–“ãƒ©ãƒ³ã‚­ãƒ³ã‚°å–å¾—ï¼ˆ`GET /ranking/friends/weekly`ï¼‰- è‡ªåˆ†è‡ªèº«ã‚‚å«ã‚€
- å‹é”æœˆé–“ãƒ©ãƒ³ã‚­ãƒ³ã‚°å–å¾—ï¼ˆ`GET /ranking/friends/monthly`ï¼‰- è‡ªåˆ†è‡ªèº«ã‚‚å«ã‚€
- å‹é”æ¯”è¼ƒï¼ˆ`GET /ranking/compare`ï¼‰

---

### âœ… ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…

#### å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«
- `frontend/liff-app/ranking.html` - ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤ºç”»é¢
- `frontend/liff-app/js/ranking.js` - ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”»é¢ãƒ­ã‚¸ãƒƒã‚¯
- `frontend/liff-app/js/api.js` - ãƒ©ãƒ³ã‚­ãƒ³ã‚°APIå‘¼ã³å‡ºã—é–¢æ•°è¿½åŠ 
- `frontend/liff-app/css/style.css` - ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”»é¢ã‚¹ã‚¿ã‚¤ãƒ«è¿½åŠ 

#### æ©Ÿèƒ½
- é€±é–“/æœˆé–“ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã®åˆ‡ã‚Šæ›¿ãˆï¼ˆå‹é”ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼‰
- ãƒ©ãƒ³ã‚­ãƒ³ã‚°ä¸€è¦§è¡¨ç¤ºï¼ˆãƒˆãƒƒãƒ—3ã«ãƒ¡ãƒ€ãƒ«è¡¨ç¤ºã€è‡ªåˆ†è‡ªèº«ã¯å¼·èª¿è¡¨ç¤ºï¼‰
- å‹é”ã‚’æ‹›å¾…ã™ã‚‹æ©Ÿèƒ½ï¼ˆæ‹›å¾…URLã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ï¼‰
- ã‚·ã‚§ã‚¢æ©Ÿèƒ½ï¼ˆLINEã‚·ã‚§ã‚¢ã¾ãŸã¯URLã‚³ãƒ”ãƒ¼ï¼‰
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

---

## ğŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †

### 1. DynamoDBãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ

#### Rankingsãƒ†ãƒ¼ãƒ–ãƒ«
1. AWS DynamoDBã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ã‚¢ã‚¯ã‚»ã‚¹
2. ã€Œãƒ†ãƒ¼ãƒ–ãƒ«ã®ä½œæˆã€ã‚’ã‚¯ãƒªãƒƒã‚¯
3. ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®š:
   - **ãƒ†ãƒ¼ãƒ–ãƒ«å**: `Rankings`
   - **ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ã‚­ãƒ¼**: `Period` (String)
   - **ã‚½ãƒ¼ãƒˆã‚­ãƒ¼**: `Rank` (Number)
4. ã€Œãƒ†ãƒ¼ãƒ–ãƒ«ã®ä½œæˆã€ã‚’ã‚¯ãƒªãƒƒã‚¯

#### ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ 
```
Period (PK): "weekly-2025-W45" ã¾ãŸã¯ "monthly-2025-11"
Rank (SK): 1, 2, 3, ...
UserId: "U1234567890..."
StampCount: 10
DisplayName: "ãƒ¦ãƒ¼ã‚¶ãƒ¼å"
UpdatedAt: 1234567890
```

---

### 2. Lambdaé–¢æ•°ã®ãƒ‡ãƒ—ãƒ­ã‚¤

#### Step 1: ZIPãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ
```bash
cd backend/lambda/ranking
./build.sh
```

#### Step 2: AWS Lambdaé–¢æ•°ã®ä½œæˆ
1. AWS Lambdaã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ã‚¢ã‚¯ã‚»ã‚¹
2. ã€Œé–¢æ•°ã®ä½œæˆã€ã‚’ã‚¯ãƒªãƒƒã‚¯
3. é–¢æ•°å: `ranking`
4. ãƒ©ãƒ³ã‚¿ã‚¤ãƒ : Python 3.11
5. ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£: x86_64
6. ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰

#### Step 3: ç’°å¢ƒå¤‰æ•°ã®è¨­å®š
- `TABLE_RANKINGS`: `Rankings`ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼‰
- `TABLE_USERSTAMPS`: `UserStamps`ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼‰
- `TABLE_USERS`: `Users`ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼‰

#### Step 4: IAMãƒ­ãƒ¼ãƒ«ã®è¨­å®š
ä»¥ä¸‹ã®æ¨©é™ã‚’è¿½åŠ :
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "dynamodb:Query",
        "dynamodb:Scan",
        "dynamodb:GetItem",
        "dynamodb:PutItem",
        "dynamodb:DeleteItem"
      ],
      "Resource": [
        "arn:aws:dynamodb:*:*:table/Rankings",
        "arn:aws:dynamodb:*:*:table/UserStamps",
        "arn:aws:dynamodb:*:*:table/Users"
      ]
    }
  ]
}
```

#### Step 5: API Gatewayçµ±åˆ
1. API Gatewayã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§æ—¢å­˜ã®APIã‚’é¸æŠ
2. ãƒªã‚½ãƒ¼ã‚¹ `/ranking` ã‚’ä½œæˆ
3. ä»¥ä¸‹ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¿½åŠ :
   - `POST /ranking/calculate` - ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¨ˆç®—
   - `GET /ranking/compare` - å‹é”æ¯”è¼ƒï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
   - `GET /ranking/friends/weekly` - å‹é”é€±é–“ãƒ©ãƒ³ã‚­ãƒ³ã‚°å–å¾—
   - `GET /ranking/friends/monthly` - å‹é”æœˆé–“ãƒ©ãƒ³ã‚­ãƒ³ã‚°å–å¾—
4. å„ãƒ¡ã‚½ãƒƒãƒ‰ã«Lambdaçµ±åˆã‚’è¨­å®šï¼ˆãƒ—ãƒ­ã‚­ã‚·çµ±åˆï¼‰
5. CORSè¨­å®šã‚’æœ‰åŠ¹åŒ–

**æ³¨æ„**: `/ranking/weekly` ã¨ `/ranking/monthly` ã¯å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚å‹é”ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã®ã¿ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚

---

### 3. ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¨ˆç®—ã®è‡ªå‹•å®Ÿè¡Œï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

#### EventBridgeãƒ«ãƒ¼ãƒ«ã®è¨­å®š
1. Amazon EventBridgeã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ã‚¢ã‚¯ã‚»ã‚¹
2. ã€Œãƒ«ãƒ¼ãƒ«ã€â†’ã€Œãƒ«ãƒ¼ãƒ«ã®ä½œæˆã€
3. ãƒ«ãƒ¼ãƒ«è¨­å®š:
   - **åå‰**: `ranking-calculation-daily`
   - **ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«**: æ¯æ—¥åˆå‰1æ™‚ï¼ˆUTCï¼‰
   - **ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ**: Lambdaé–¢æ•° `ranking`
   - **å…¥åŠ›**: å®šæ•°JSON
     ```json
     {
       "httpMethod": "POST",
       "path": "/ranking/calculate",
       "queryStringParameters": {
         "type": "weekly"
       }
     }
     ```

---

## ğŸ“ APIä»•æ§˜

### POST /ranking/calculate
ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’è¨ˆç®—ã—ã¦DynamoDBã«ä¿å­˜

**ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿:**
- `type`: `weekly` ã¾ãŸã¯ `monthly`ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: `weekly`ï¼‰

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹:**
```json
{
  "ok": true,
  "period": "2025-W45",
  "period_type": "weekly",
  "rankings_count": 10
}
```

---

### GET /ranking/friends/weekly
å‹é”ã®é€±é–“ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’å–å¾—ï¼ˆè‡ªåˆ†è‡ªèº«ã‚‚å«ã‚€ï¼‰

**ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿:**
- `user_id`: ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆå¿…é ˆï¼‰
- `period`: æœŸé–“æ–‡å­—åˆ—ï¼ˆä¾‹: `2025-W46`ã€çœç•¥æ™‚ã¯ç¾åœ¨ã®é€±ï¼‰

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹:**
```json
{
  "ok": true,
  "period": "2025-W46",
  "period_type": "weekly",
  "rankings": [
    {
      "rank": 1,
      "user_id": "U1234567890...",
      "stamp_count": 15,
      "display_name": "ãƒ¦ãƒ¼ã‚¶ãƒ¼1",
      "is_self": true
    },
    {
      "rank": 2,
      "user_id": "U0987654321...",
      "stamp_count": 12,
      "display_name": "å‹é”1",
      "is_self": false
    }
  ]
}
```

**æ³¨æ„**: å‹é”ãƒªã‚¹ãƒˆã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹å‹é”ã¨è‡ªåˆ†è‡ªèº«ãŒãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«å«ã¾ã‚Œã¾ã™ã€‚

---

### GET /ranking/friends/monthly
å‹é”ã®æœˆé–“ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’å–å¾—ï¼ˆè‡ªåˆ†è‡ªèº«ã‚‚å«ã‚€ï¼‰

**ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿:**
- `user_id`: ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆå¿…é ˆï¼‰
- `period`: æœŸé–“æ–‡å­—åˆ—ï¼ˆä¾‹: `2025-11`ã€çœç•¥æ™‚ã¯ç¾åœ¨ã®æœˆï¼‰

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹:**
```json
{
  "ok": true,
  "period": "2025-11",
  "period_type": "monthly",
  "rankings": [
    {
      "rank": 1,
      "user_id": "U1234567890...",
      "stamp_count": 50,
      "display_name": "ãƒ¦ãƒ¼ã‚¶ãƒ¼1",
      "is_self": true
    },
    {
      "rank": 2,
      "user_id": "U0987654321...",
      "stamp_count": 45,
      "display_name": "å‹é”1",
      "is_self": false
    }
  ]
}
```

**æ³¨æ„**: å‹é”ãƒªã‚¹ãƒˆã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹å‹é”ã¨è‡ªåˆ†è‡ªèº«ãŒãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«å«ã¾ã‚Œã¾ã™ã€‚

---

### GET /ranking/compare
2äººã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ¯”è¼ƒ

**ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿:**
- `user_id`: ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆå¿…é ˆï¼‰
- `friend_id`: å‹é”ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆå¿…é ˆï¼‰

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹:**
```json
{
  "ok": true,
  "user": {
    "user_id": "U1234567890...",
    "display_name": "ãƒ¦ãƒ¼ã‚¶ãƒ¼1",
    "stamp_count": 15
  },
  "friend": {
    "user_id": "U0987654321...",
    "display_name": "ãƒ¦ãƒ¼ã‚¶ãƒ¼2",
    "stamp_count": 12
  },
  "rank_diff": 3,
  "user_is_higher": true
}
```

---

## ğŸ§ª ãƒ†ã‚¹ãƒˆæ–¹æ³•

### ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¨ˆç®—ã®ãƒ†ã‚¹ãƒˆ
```bash
curl -X POST "https://2bm71jvfs6.execute-api.us-east-1.amazonaws.com/dev/ranking/calculate?type=weekly"
```

### å‹é”é€±é–“ãƒ©ãƒ³ã‚­ãƒ³ã‚°å–å¾—ã®ãƒ†ã‚¹ãƒˆ
```bash
curl -X GET "https://2bm71jvfs6.execute-api.us-east-1.amazonaws.com/dev/ranking/friends/weekly?user_id=USER_ID"
```

### å‹é”æœˆé–“ãƒ©ãƒ³ã‚­ãƒ³ã‚°å–å¾—ã®ãƒ†ã‚¹ãƒˆ
```bash
curl -X GET "https://2bm71jvfs6.execute-api.us-east-1.amazonaws.com/dev/ranking/friends/monthly?user_id=USER_ID"
```

### å‹é”æ¯”è¼ƒã®ãƒ†ã‚¹ãƒˆ
```bash
curl -X GET "https://2bm71jvfs6.execute-api.us-east-1.amazonaws.com/dev/ranking/compare?user_id=USER_ID&friend_id=FRIEND_ID"
```

---

## ğŸ¨ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ä½¿ç”¨æ–¹æ³•

### ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”»é¢ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹
1. LIFFã‚¢ãƒ—ãƒªã‚’é–‹ã
2. `ranking.html` ã«ã‚¢ã‚¯ã‚»ã‚¹
3. é€±é–“/æœˆé–“ã‚¿ãƒ–ã§åˆ‡ã‚Šæ›¿ãˆ

### ã‚·ã‚§ã‚¢æ©Ÿèƒ½
1. ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”»é¢ã§ã€Œçµæœã‚’ã‚·ã‚§ã‚¢ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
2. LINEã‚·ã‚§ã‚¢æ©Ÿèƒ½ãŒåˆ©ç”¨å¯èƒ½ãªå ´åˆã¯ã€å‹é”é¸æŠç”»é¢ãŒè¡¨ç¤º
3. åˆ©ç”¨ã§ããªã„å ´åˆã¯ã€URLãŒã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã•ã‚Œã‚‹

---

## âš ï¸ æ³¨æ„äº‹é …

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹
- ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¨ˆç®—ã¯`UserStamps`ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã™ã‚‹ãŸã‚ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°ãŒå¤šã„å ´åˆã¯æ™‚é–“ãŒã‹ã‹ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™
- å®Ÿéš›ã®é‹ç”¨ã§ã¯ã€æ—¥æ¬¡ãƒãƒƒãƒå‡¦ç†ã§ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’äº‹å‰è¨ˆç®—ã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™

### ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§
- ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¨ˆç®—ã¯æœŸé–“å†…ã®ã‚¹ã‚¿ãƒ³ãƒ—ã®ã¿ã‚’ã‚«ã‚¦ãƒ³ãƒˆã—ã¾ã™
- é€±é–“ãƒ©ãƒ³ã‚­ãƒ³ã‚°: ç¾åœ¨ã®é€±ã®æœˆæ›œæ—¥0æ™‚00åˆ†00ç§’ã‹ã‚‰ç¾åœ¨æ™‚åˆ»ã¾ã§
- æœˆé–“ãƒ©ãƒ³ã‚­ãƒ³ã‚°: ç¾åœ¨ã®æœˆã®1æ—¥0æ™‚00åˆ†00ç§’ã‹ã‚‰ç¾åœ¨æ™‚åˆ»ã¾ã§
- å‹é”ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«ã¯ã€Friendsãƒ†ãƒ¼ãƒ–ãƒ«ã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹å‹é”ã¨è‡ªåˆ†è‡ªèº«ãŒå«ã¾ã‚Œã¾ã™

### ã‚³ã‚¹ãƒˆç®¡ç†
- DynamoDBã®ã‚¹ã‚­ãƒ£ãƒ³æ“ä½œã¯èª­ã¿å–ã‚Šå®¹é‡ãƒ¦ãƒ‹ãƒƒãƒˆã‚’æ¶ˆè²»ã—ã¾ã™
- ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¨ˆç®—ã¯å®šæœŸçš„ã«å®Ÿè¡Œã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™ï¼ˆæ—¥æ¬¡ãªã©ï¼‰

---

## ğŸ“š å‚è€ƒè³‡æ–™

- [DynamoDB ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.aws.amazon.com/ja_jp/amazondynamodb/)
- [EventBridge ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ«ãƒ¼ãƒ«](https://docs.aws.amazon.com/ja_jp/eventbridge/latest/userguide/eb-create-rule-schedule.html)

---

**æœ€çµ‚æ›´æ–°**: 2025å¹´1æœˆ

