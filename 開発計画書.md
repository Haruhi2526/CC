# スタンプラリーLIFFアプリ 開発計画書

## 1. プロジェクト概要

### 1.1 目的
AWSを活用したスタンプラリーLIFFアプリを開発し、位置情報と画像認識機能を活用したスタンプ収集システムを実現する。

### 1.2 主要機能
1. **GPS位置情報ベースのスタンプ収集**
   - ユーザーが指定された場所から半径100m以内にいることを検知
   - GPS位置情報を取得し、到達判定
   - スタンプの授与

2. **画像認識ベースのスタンプ収集**
   - 特徴的な物体の写真を撮影・アップロード
   - AI画像認識により正解判定
   - スタンプの授与

3. **LIFF統合機能**
   - LINEアカウントでの認証・ログイン
   - スタンプ収集状況の管理
   - ユーザーダッシュボード表示

### 1.3 ターゲットユーザー
- イベント参加者
- 観光客
- 店舗・施設利用者

## 2. アーキテクチャ設計

### 2.1 システム構成図

```
┌─────────────────────────────────────────────────────────────┐
│                        LIFF フロントエンド                      │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐       │
│  │  スタンプ一覧  │  │   GPS画面    │  │ 写真撮影画面 │       │
│  └──────────────┘  └──────────────┘  └──────────────┘       │
└─────────────────────────────────────────────────────────────┘
                           │
                           │ HTTPS
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                    AWS API Gateway                            │
│                   (認証・ルーティング)                         │
└─────────────────────────────────────────────────────────────┘
                           │
        ┌──────────────────┼──────────────────┐
        │                  │                  │
        ▼                  ▼                  ▼
┌──────────────┐  ┌──────────────┐  ┌──────────────┐
│  Lambda Fn1  │  │  Lambda Fn2  │  │  Lambda Fn3  │
│ スタンプ取得  │  │ 位置情報検証  │  │ 画像認識処理  │
└──────────────┘  └──────────────┘  └──────────────┘
        │                  │                  │
        │                  │                  │
        ▼                  ▼                  ▼
┌─────────────────────────────────────────────────────────────┐
│                      DynamoDB                                 │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐       │
│  │  ユーザーデータ│  │ スタンプマスタ│  │ 収集履歴     │       │
│  └──────────────┘  └──────────────┘  └──────────────┘       │
└─────────────────────────────────────────────────────────────┘

                          │
                          ▼
              ┌───────────────────────────┐
              │   Amazon Rekognition       │
              │   (画像認識サービス)       │
              └───────────────────────────┘
                          │
                          ▼
              ┌───────────────────────────┐
              │   Amazon S3                │
              │   (画像ストレージ)         │
              └───────────────────────────┘
```

### 2.2 主要AWSサービスの選定理由

| サービス | 用途 | 選定理由 |
|---------|------|---------|
| **API Gateway** | APIエンドポイント | RESTful APIの構築、認証管理 |
| **Lambda** | サーバーレス関数実行 | コスト効率、自動スケーリング、メンテナンス不要 |
| **DynamoDB** | NoSQLデータベース | 高速な読み書き、スケーラビリティ、フルマネージド |
| **Rekognition** | AI画像認識 | 高精度な物体認識、カスタムラベル検出 |
| **S3** | オブジェクトストレージ | 画像データの保存、高可用性 |
| **Cognito** | 認証・認可 | ユーザー管理、セキュリティトークン発行 |

### 2.3 データフロー

#### GPSベースのスタンプ収集フロー
1. ユーザーがアプリを開き、GPS位置情報を送信
2. API Gatewayがリクエストを受信
3. Lambda関数が位置情報を検証（目標地点からの距離計算）
4. 100m以内ならDynamoDBにスタンプ情報を登録
5. 結果をフロントエンドに返却

#### 画像認識ベースのスタンプ収集フロー
1. ユーザーがカメラで写真を撮影
2. 画像をBase64エンコードしてAPIに送信
3. Lambda関数がS3に画像をアップロード
4. Amazon Rekognitionで画像認識を実行
5. 正解判定後、DynamoDBにスタンプ情報を登録
6. 結果をフロントエンドに返却

## 3. データベース設計

### 3.1 DynamoDBテーブル構成

#### テーブル1: UserStamps (ユーザーのスタンプ収集状況)
| 項目名 | 型 | 説明 |
|--------|-----|------|
| UserId | String (パーティションキー) | LINE UID |
| StampId | String (ソートキー) | スタンプID |
| CollectedAt | Number | 収集日時（Unixタイムスタンプ） |
| Method | String | 収集方法（GPS/IMAGE） |
| TTL | Number | データ有効期限（削除用） |

#### テーブル2: StampMasters (スタンプマスタ情報)
| 項目名 | 型 | 説明 |
|--------|-----|------|
| StampId | String (パーティションキー) | スタンプID |
| Name | String | スタンプ名 |
| Description | String | 説明 |
| Type | String | 収集タイプ（GPS/IMAGE） |
| Location | Map | GPS座標（lat, lng, radius） |
| ImageLabel | String | 画像認識用ラベル |
| ValidFrom | Number | 有効開始日時 |
| ValidTo | Number | 有効終了日時 |

#### テーブル3: Users (ユーザー基本情報)
| 項目名 | 型 | 説明 |
|--------|-----|------|
| UserId | String (パーティションキー) | LINE UID |
| DisplayName | String | 表示名 |
| LineId | String | LINE ID |
| CreatedAt | Number | 登録日時 |
| LastLoginAt | Number | 最終ログイン日時 |

### 3.2 位置情報検証ロジック

```python
import math

def calculate_distance(lat1, lon1, lat2, lon2):
    """
    Haversine公式を使用して2点間の距離を計算（単位：メートル）
    """
    R = 6371000  # 地球の半径（メートル）
    
    phi1 = math.radians(lat1)
    phi2 = math.radians(lat2)
    delta_phi = math.radians(lat2 - lat1)
    delta_lambda = math.radians(lon2 - lon1)
    
    a = math.sin(delta_phi/2)**2 + \
        math.cos(phi1) * math.cos(phi2) * math.sin(delta_lambda/2)**2
    c = 2 * math.atan2(math.sqrt(a), math.sqrt(1-a))
    
    return R * c
```

## 4. 開発スケジュール

### フェーズ1: 環境構築・基盤整備 (Week 1-2)
- [ ] AWSアカウントの設定
- [ ] DynamoDBテーブルの作成
- [ ] S3バケットの作成
- [ ] API Gatewayのセットアップ
- [ ] Lambda関数の雛形作成
- [ ] 開発環境の構築

### フェーズ2: バックエンド開発 (Week 3-4)
- [ ] Lambda: ユーザー認証処理
- [ ] Lambda: スタンプマスタ取得API
- [ ] Lambda: GPS位置情報検証API
- [ ] Lambda: 画像アップロード・認識API
- [ ] Rekognitionカスタムラベルの設定
- [ ] エラーハンドリング・ログ実装

### フェーズ3: フロントエンド開発 (Week 5-6)
- [ ] LIFFアプリの基本構成
- [ ] LINEログイン実装
- [ ] ダッシュボード画面
- [ ] GPS取得機能
- [ ] カメラ撮影機能
- [ ] スタンプ一覧表示
- [ ] UI/UXデザイン

### フェーズ4: 統合・テスト (Week 7)
- [ ] エンドツーエンドテスト
- [ ] 位置情報精度テスト
- [ ] 画像認識精度テスト
- [ ] 負荷テスト
- [ ] セキュリティテスト
- [ ] バグ修正

### フェーズ5: デプロイ・本番リリース (Week 8)
- [ ] 本番環境へのデプロイ
- [ ] モニタリング設定
- [ ] ドキュメント作成
- [ ] ユーザー向け操作ガイド作成
- [ ] リリース

## 5. 技術スタック

### 5.1 フロントエンド
- **LIFF (LINE Frontend Framework)**: 2.x系
- **HTML5/CSS3/JavaScript (ES6+)**
- **Geolocation API**: GPS位置情報取得
- **MediaDevices.getUserMedia()**: カメラアクセス
- **Fetch API**: RESTful API通信

### 5.2 バックエンド
- **Python 3.9+**: Lambda関数の開発言語
- **boto3**: AWS SDK for Python
- **AWS SAM**: サーバーレスアプリケーションのデプロイ

### 5.3 インフラ
- **AWS CloudFormation**: インフラのコード化
- **AWS CloudWatch**: ログ・モニタリング

## 6. セキュリティ対策

### 6.1 認証・認可
- LINE OAuth 2.0を使用したユーザー認証
- API Gatewayで認証トークンの検証
- Cognitoによる一時認証情報の発行

### 6.2 データ保護
- HTTPSによる通信の暗号化
- S3での画像の暗号化保存
- DynamoDBでの機密情報の暗号化

### 6.3 リクエスト制限
- API Gatewayでのレート制限設定
- CORSポリシーの適切な設定
- 不正な位置情報送信の検知

## 7. コスト見積もり

### 月間コスト概算（想定ユーザー数: 1,000人、日アクセス: 100人）

| サービス | リクエスト数 | 単価 | 月額コスト |
|---------|------------|------|-----------|
| Lambda実行 | 10,000回 | $0.20/100万回 | $0.002 |
| DynamoDB読み書き | 50,000回 | $1.25/100万回 | $0.063 |
| S3ストレージ (1GB) | - | $0.023/GB | $0.023 |
| S3データ転送 | 500MB | $0.09/GB | $0.045 |
| Rekognition | 1,000枚 | $1.00/1000枚 | $1.00 |
| API Gateway | 10,000回 | $3.50/100万回 | $0.035 |
| **合計** | | | **約$1.17/月** |

※ 実際のコストは使用量により変動します

## 8. 運用・監視

### 8.1 CloudWatch設定
- Lambda関数の実行ログ
- API Gatewayのアクセスログ
- DynamoDBの読み書きメトリクス
- エラー率の監視

### 8.2 アラート設定
- Lambda関数のエラー発生時
- APIレスポンスタイム超過時
- DynamoDBのキャパシティ超過時
- Rekognition APIの呼び出し失敗時

### 8.3 バックアップ・復旧
- DynamoDBポイントインタイムリカバリ
- S3バージョニング有効化
- 設定のGit管理

## 9. UI/UX デザイン案

### 9.1 画面構成
1. **ホーム画面**: ユーザーのスタンプ収集状況一覧
2. **GPSスタンプ画面**: 現在地表示、目標地点までの距離表示
3. **カメラスタンプ画面**: 撮影モード、プレビュー画面
4. **スタンプ詳細画面**: 各スタンプの説明、取得状態

### 9.2 デザイン要件
- LINEアプリ内での統一感のあるデザイン
- 直感的な操作性
- 快適な読み込み速度
- レスポンシブ対応

## 10. 課題とリスク

### 10.1 技術的課題
- **GPS精度**: 屋内での位置情報取得の精度低下
  - 対策: より大きな許容範囲の設定、複数回の測定
- **画像認識精度**: 似た物体との誤認識
  - 対策: カスタムラベルの詳細なトレーニング、閾値の調整

### 10.2 運用上のリスク
- **サーバーレスコールドスタート**: 初回起動時の遅延
  - 対策: プロビジョンド並行性の設定
- **不正利用**: GPS偽造、画像のズレ検出
  - 対策: タイムスタンプ検証、複数回の検証

## 11. 拡張性の検討

### 11.1 将来の機能追加案
- スタンプの友達共有機能
- ランキング機能
- 報酬・景品機能
- 複数イベントの管理
- AR機能の統合

### 11.2 スケーラビリティ
- Lambdaの自動スケーリング機能を活用
- DynamoDBのオンデマンドモード利用
- CloudFrontの導入（CDN）

## 12. 成果物

### 12.1 開発成果物
- LIFFアプリのソースコード
- Lambda関数のソースコード
- CloudFormation/SAMテンプレート
- データベーススキーマ
- API仕様書

### 12.2 ドキュメント
- 本開発計画書
- 技術仕様書
- 運用マニュアル
- ユーザーマニュアル

## 13. 開発体制

### 13.1 必要スキル
- AWS（Lambda, DynamoDB, S3, API Gateway, Rekognition）
- Python
- JavaScript/HTML5/CSS3
- LIFF開発経験
- Git/GitHub

### 13.2 推奨学習リソース
- AWS公式ドキュメント
- LINE Developersドキュメント
- Amazon Rekognition 開発者ガイド

## 14. 次のアクション

### 即座に実施すべき項目
1. AWSアカウントの開設確認
2. LINE Developersアカウントの作成
3. LIFFアプリのチャネル設定
4. ローカル開発環境の構築
5. GitHubリポジトリの作成

---

**作成日**: 2024年
**バージョン**: 1.0
**作成者**: [あなたの名前]

